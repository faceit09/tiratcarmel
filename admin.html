<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול בתי כנסת - טירת הכרמל</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }</style>
</head>
<body class="bg-gray-100">
    <div id="login-screen" class="flex items-center justify-center h-screen bg-blue-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
            <h2 class="text-2xl font-bold mb-6 text-center">כניסה למערכת</h2>
            <input type="text" id="username" placeholder="שם משתמש" class="w-full mb-3 p-3 border rounded">
            <input type="password" id="password" placeholder="סיסמה" class="w-full mb-6 p-3 border rounded">
            <button id="loginBtn" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">התחבר</button>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden min-h-screen">
        <nav class="bg-white shadow p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-900">ניהול לוח בתי כנסת</h1>
            <button onclick="location.reload()" class="text-red-500 font-bold">התנתק</button>
        </nav>

        <div class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded shadow-lg">
                <h3 id="formTitle" class="text-lg font-bold mb-4 text-green-700">הוספת בית כנסת חדש</h3>
                <input type="text" id="shulName" placeholder="שם בית הכנסת" class="w-full p-2 border rounded mb-3">
                <input type="text" id="shulNickname" placeholder="כינוי (אופציונלי)" class="w-full p-2 border rounded mb-3">
                
                <div class="bg-blue-50 p-3 rounded mb-4">
                    <label class="block text-xs font-bold mb-1">הודעות ושמות:</label>
                    <textarea id="shulMessage" placeholder="הודעה חשובה..." class="w-full p-2 border rounded text-sm mb-2"></textarea>
                    <textarea id="shulRefuah" placeholder="לרפואה..." class="w-full p-2 border rounded text-sm mb-2"></textarea>
                    <textarea id="shulNishmat" placeholder="לעילוי נשמת..." class="w-full p-2 border rounded text-sm"></textarea>
                </div>

                <div class="bg-gray-50 p-3 rounded mb-4">
                    <div class="flex gap-2 mb-2">
                        <select id="timeType" class="w-1/2 p-2 border rounded"><option value="shacharit">שחרית</option><option value="mincha">מנחה</option><option value="arvit">ערבית</option></select>
                        <select id="timeDay" class="w-1/2 p-2 border rounded">
                            <option value="חול">חול</option><option value="יום ראשון">יום ראשון</option>
                            <option value="שבת">שבת</option><option value="מוצ״ש">מוצ״ש</option>
                        </select>
                    </div>
                    <select id="timeMode" class="w-full p-2 border rounded mb-2">
                        <option value="manual">שעה קבועה</option>
                        <option value="before_sunset">דקות לפני שקיעה</option>
                        <option value="before_exit_shabbat">דקות לפני צאת שבת</option>
                        <option value="stars">צאת הכוכבים</option>
                    </select>
                    <div class="flex gap-2">
                        <input type="time" id="timeClock" class="p-2 border rounded flex-grow">
                        <input type="number" id="minutesInput" placeholder="דקות" class="hidden p-2 border rounded w-20">
                        <button id="addTimeBtn" class="bg-green-600 text-white px-4 rounded font-bold">הוסף</button>
                    </div>
                </div>

                <div id="timesList" class="mb-4 text-xs space-y-1"></div>
                <button id="saveShulBtn" class="w-full bg-blue-600 text-white py-3 rounded font-bold shadow">שמור בית כנסת</button>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded shadow">
                <h3 class="font-bold mb-4 border-b pb-2">בתי כנסת קיימים</h3>
                <div id="shulListContainer" class="space-y-2">טוען נתונים...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArvTHLvtHZwguLn0OpPMMJdqDKS7OnDOg",
            authDomain: "tirat-carmel-shul.firebaseapp.com",
            databaseURL: "https://tirat-carmel-shul-default-rtdb.firebaseio.com",
            projectId: "tirat-carmel-shul",
            storageBucket: "tirat-carmel-shul.firebasestorage.app",
            messagingSenderId: "645574971282",
            appId: "1:645574971282:web:9fb6720ea7c960ca37fb4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let tempTimes = { shacharit: [], mincha: [], arvit: [] };
        let editingId = null;

        document.getElementById('loginBtn').onclick = () => {
            if(document.getElementById('username').value === 'admin') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
            }
        };

        document.getElementById('timeMode').onchange = (e) => {
            document.getElementById('timeClock').classList.toggle('hidden', e.target.value !== 'manual');
            document.getElementById('minutesInput').classList.toggle('hidden', !e.target.value.includes('before_'));
        };

        document.getElementById('addTimeBtn').onclick = () => {
            const type = document.getElementById('timeType').value;
            const day = document.getElementById('timeDay').value;
            const mode = document.getElementById('timeMode').value;
            let val = "";
            if(mode === 'manual') val = document.getElementById('timeClock').value;
            else if(mode === 'before_sunset') val = document.getElementById('minutesInput').value + " דק' לפני שקיעה";
            else if(mode === 'before_exit_shabbat') val = document.getElementById('minutesInput').value + " דק' לפני צאת שבת";
            else val = "צאת הכוכבים";
            
            tempTimes[type].push({ day, time: val });
            renderTempTimes();
        };

        function renderTempTimes() {
            const container = document.getElementById('timesList');
            container.innerHTML = "";
            Object.keys(tempTimes).forEach(type => {
                tempTimes[type].forEach((t, i) => {
                    container.innerHTML += `<div class="bg-gray-100 p-1 rounded flex justify-between"><span>${type}: ${t.day} ${t.time}</span><button class="text-red-500" onclick="removeTemp('${type}', ${i})">×</button></div>`;
                });
            });
        }
        window.removeTemp = (type, i) => { tempTimes[type].splice(i, 1); renderTempTimes(); };

        document.getElementById('saveShulBtn').onclick = () => {
            const name = document.getElementById('shulName').value;
            if(!name) return alert("הכנס שם");
            const format = (type, isShab) => tempTimes[type].filter(t => isShab ? (t.day === 'שבת' || t.day === 'מוצ״ש') : (t.day !== 'שבת' && t.day !== 'מוצ״ש')).map(t => (t.day === 'חול' ? '' : t.day + ' ') + t.time).join(', ');
            
            const data = {
                name, nickname: document.getElementById('shulNickname').value,
                message: document.getElementById('shulMessage').value,
                refuahNames: document.getElementById('shulRefuah').value,
                iluiNishmatNames: document.getElementById('shulNishmat').value,
                shacharit_chol: format('shacharit', false), mincha_chol: format('mincha', false), arvit_chol: format('arvit', false),
                shacharit_shabbat: format('shacharit', true), mincha_shabbat: format('mincha', true), arvit_shabbat: format('arvit', true),
                rawTimes: tempTimes
            };
            const shulRef = editingId ? ref(db, 'prayers/' + editingId) : push(ref(db, 'prayers'));
            set(shulRef, data).then(() => { alert("נשמר!"); location.reload(); });
        };

        onValue(ref(db, 'prayers'), (snap) => {
            const container = document.getElementById('shulListContainer');
            container.innerHTML = "";
            if(!snap.val()) { container.innerHTML = "אין בתי כנסת."; return; }
            Object.entries(snap.val()).forEach(([id, val]) => {
                const div = document.createElement('div');
                div.className = "p-3 border-b flex justify-between items-center";
                div.innerHTML = `<span><b>${val.name}</b></span><div><button class="bg-blue-500 text-white px-2 py-1 rounded text-xs mr-1">ערוך</button><button class="bg-red-500 text-white px-2 py-1 rounded text-xs">מחק</button></div>`;
                div.querySelectorAll('button')[0].onclick = () => { editingId = id; document.getElementById('shulName').value = val.name; document.getElementById('shulNickname').value = val.nickname || ''; tempTimes = val.rawTimes || { shacharit: [], mincha: [], arvit: [] }; renderTempTimes(); };
                div.querySelectorAll('button')[1].onclick = () => confirm("למחוק?") && remove(ref(db, 'prayers/' + id));
                container.appendChild(div);
            });
        });
    </script>
</body>
</html>