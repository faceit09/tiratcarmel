<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××¢×¨×›×ª - ×’×‘××™ (××•× ×œ×™×™×Ÿ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .nav-btn { background-color: white; color: #4b5563; }
        .time-tag { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-blue-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <div class="mb-4 text-blue-600 text-5xl"><i class="fas fa-synagogue"></i></div>
            <h2 class="text-2xl font-bold mb-4">×›× ×™×¡×ª ×’×‘××™ / ×× ×”×œ</h2>
            <input type="text" id="username" placeholder="×©× ××©×ª××©" class="w-full mb-3 p-3 border rounded-lg bg-gray-50">
            <input type="password" id="password" placeholder="×¡×™×¡××”" class="w-full mb-6 p-3 border rounded-lg bg-gray-50">
            <button id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">×”×›× ×¡ ×œ××¢×¨×›×ª</button>
            <p id="error-msg" class="text-red-500 text-sm mt-3 hidden">×¤×¨×˜×™× ×©×’×•×™×™×</p>
            <p id="loading-msg" class="text-blue-500 text-sm mt-3 hidden">××××ª ×¤×¨×˜×™×...</p>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden min-h-screen pb-20">
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center text-blue-900 font-bold text-xl">
                <i class="fas fa-cloud ml-2"></i> <span id="navTitle">×¤×× ×œ × ×™×”×•×œ</span>
            </div>
            <button id="logoutBtn" class="text-red-500 text-sm hover:bg-red-50 px-3 py-1 rounded">×”×ª× ×ª×§</button>
        </nav>

        <div class="container mx-auto mt-6 px-4 flex justify-center gap-4" id="adminNavButtons">
            <button id="btn-prayers" class="nav-btn active px-6 py-2 rounded-full font-bold shadow-sm transition">
                <i class="fas fa-synagogue ml-2"></i>× ×™×”×•×œ ×‘×ª×™ ×›× ×¡×ª
            </button>
            <button id="btn-lessons" class="nav-btn px-6 py-2 rounded-full font-bold shadow-sm transition">
                <i class="fas fa-book-open ml-2"></i>× ×™×”×•×œ ×©×™×¢×•×¨×™×
            </button>
        </div>

        <div class="container mx-auto p-6">
            
            <div id="globalSettingsPanel" class="bg-indigo-50 border border-indigo-200 p-4 rounded-xl mb-6 hidden">
                <h3 class="text-lg font-bold text-indigo-900 mb-3"><i class="fas fa-clock ml-2"></i>×”×’×“×¨×•×ª ×–×× ×™× ×’×œ×•×‘×œ×™×•×ª (×“×§×•×ª)</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                    <div>
                        <label class="block font-bold mb-1">×›× ×™×¡×ª ×©×‘×ª (+)</label>
                        <input type="number" id="setting_entry" class="w-full p-2 border rounded text-center" value="11">
                    </div>
                    <div>
                        <label class="block font-bold mb-1">×™×¦×™××ª ×©×‘×ª (+)</label>
                        <input type="number" id="setting_exit" class="w-full p-2 border rounded text-center" value="0">
                    </div>
                    <div>
                        <label class="block font-bold mb-1">×¢×œ×•×ª ×”×©×—×¨ (+)</label>
                        <input type="number" id="setting_alot" class="w-full p-2 border rounded text-center" value="14">
                    </div>
                    <div>
                        <label class="block font-bold mb-1">×˜×œ×™×ª/×ª×¤×™×œ×™×Ÿ (-)</label>
                        <input type="number" id="setting_talit" class="w-full p-2 border rounded text-center" value="-2">
                    </div>
                    <div>
                        <label class="block font-bold mb-1">×¦××ª ×”×›×•×›×‘×™× (-)</label>
                        <input type="number" id="setting_tzeit" class="w-full p-2 border rounded text-center" value="-8">
                    </div>
                </div>
                <button id="saveSettingsBtn" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 font-bold w-full md:w-auto">×©××•×¨ ×”×’×“×¨×•×ª ×–×× ×™×</button>
            </div>

            <div id="section-prayers" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1" id="editFormContainer">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-24 overflow-y-auto max-h-[90vh]">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-green-700" id="formTitle">×”×•×¡×¤×ª ×‘×™×ª ×›× ×¡×ª</h3>
                            <button id="cancelEditBtn" class="hidden text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded">×‘×™×˜×•×œ / ×—×“×©</button>
                        </div>
                        
                        <div id="authFields" class="bg-yellow-50 p-3 rounded border border-yellow-200 mb-4 hidden">
                            <h4 class="text-xs font-bold text-yellow-800 mb-2">ğŸ”‘ ×¤×¨×˜×™ ×’×™×©×” ×œ×’×‘××™</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="shulUser" placeholder="×©× ××©×ª××©" class="w-full p-2 border rounded text-sm">
                                <input type="text" id="shulPass" placeholder="×¡×™×¡××”" class="w-full p-2 border rounded text-sm">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs font-bold text-gray-500">×©× ×¨×©××™</label><input type="text" id="shulName" class="w-full p-2 border rounded" required></div>
                            <div><label class="text-xs font-bold text-gray-500">×›×™× ×•×™</label><input type="text" id="shulNickname" class="w-full p-2 border rounded"></div>
                        </div>

                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×›×ª×•×‘×ª</label><input type="text" id="shulAddress" class="w-full p-2 border rounded"></div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs font-bold text-gray-500">× ×•×¡×—</label><select id="shulNusach" class="w-full p-2 border rounded bg-slate-50"><option value="×¢×“×•×ª ×”××–×¨×—">×¢×“×•×ª ×”××–×¨×—</option><option value="×¡×¤×¨×“">×¡×¤×¨×“</option><option value="××©×›× ×–">××©×›× ×–</option><option value="×ª×™××Ÿ">×ª×™××Ÿ</option><option value="×—×‘×´×“">×—×‘×´×“</option><option value="××¨×•×§××™">××¨×•×§××™</option><option value="××—×™×“">××—×™×“</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">×¨×‘</label><input type="text" id="shulRabbi" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="mb-4"><label class="text-xs font-bold text-gray-500">×’×‘××™</label><input type="text" id="shulGabbai" class="w-full p-2 border rounded"></div>

                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 mb-4">
                            <label class="block text-xs font-bold text-blue-900 mb-2"><i class="fas fa-bullhorn ml-1"></i> ×œ×•×— ××•×“×¢×•×ª ×•×©××•×ª</label>
                            <div class="mb-2"><textarea id="shulMessage" rows="2" class="w-full p-2 border rounded text-sm" placeholder="×”×•×“×¢×” ×—×©×•×‘×”..."></textarea></div>
                            <div class="grid grid-cols-2 gap-2">
                                <textarea id="shulRefuah" rows="3" class="w-full p-2 border rounded text-sm" placeholder="×©××•×ª ×œ×¨×¤×•××”..."></textarea>
                                <textarea id="shulNishmat" rows="3" class="w-full p-2 border rounded text-sm" placeholder="×œ×¢×™×œ×•×™ × ×©××ª..."></textarea>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                            <label class="block text-xs font-bold text-gray-700 mb-2">ğŸ“… ×–×× ×™×</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select id="timeType" class="p-2 text-sm border rounded"><option value="shacharit">×©×—×¨×™×ª</option><option value="mincha">×× ×—×”</option><option value="arvit">×¢×¨×‘×™×ª</option></select>
                                <select id="timeDay" class="p-2 text-sm border rounded">
                                    <option value="chol">×™××™ ×—×•×œ (×¨×’×™×œ)</option>
                                    <option value="Sunday">×™×•× ×¨××©×•×Ÿ</option>
                                    <option value="Monday">×™×•× ×©× ×™</option>
                                    <option value="Tuesday">×™×•× ×©×œ×™×©×™</option>
                                    <option value="Wednesday">×™×•× ×¨×‘×™×¢×™</option>
                                    <option value="Thursday">×™×•× ×—××™×©×™</option>
                                    <option value="Friday">×™×•× ×©×™×©×™</option>
                                    <option value="Motzash">××•×¦"×©</option>
                                    <option disabled>â”€â”€</option>
                                    <option value="shabbat">×©×‘×ª</option>
                                    <option value="chag">×—×’</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <select id="timeMode" class="w-full p-2 text-sm border rounded bg-blue-50 text-blue-900 font-medium">
                                    <option value="manual">ğŸ•’ ×©×¢×” ××“×•×™×§×ª</option>
                                    <option value="before_sunset">â³ ×“×§×•×ª ×œ×¤× ×™ ×©×§×™×¢×”</option>
                                    <option value="before_exit_shabbat">â³ ×“×§×•×ª ×œ×¤× ×™ ×¦××ª ×©×‘×ª</option>
                                    <option value="sunset">ğŸŒ… ×©×§×™×¢×”</option>
                                    <option value="stars">âœ¨ ×¦××ª ×”×›×•×›×‘×™×</option>
                                    <option value="candles">ğŸ•¯ï¸ ×›× ×™×¡×ª ×©×‘×ª</option>
                                    <option value="sunrise">â˜€ï¸ ×”× ×¥ ×”×—××”</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <input type="time" id="timeClock" class="p-2 text-sm border rounded flex-grow">
                                <input type="number" id="minutesInput" placeholder="×“×§×•×ª" class="hidden p-2 text-sm border rounded w-20 flex-grow">
                                <button type="button" id="addTimeBtn" class="bg-green-600 text-white px-4 rounded hover:bg-green-700 font-bold"><i class="fas fa-plus"></i> ×”×•×¡×£</button>
                            </div>
                        </div>

                        <div id="timesListContainer" class="space-y-2 mb-4 text-sm">
                            <div id="list-shacharit" class="hidden border-r-2 border-yellow-400 pr-2"><span class="font-bold text-xs text-yellow-700 block">×©×—×¨×™×ª:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                            <div id="list-mincha" class="hidden border-r-2 border-orange-400 pr-2"><span class="font-bold text-xs text-orange-700 block">×× ×—×”:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                            <div id="list-arvit" class="hidden border-r-2 border-blue-400 pr-2"><span class="font-bold text-xs text-blue-700 block">×¢×¨×‘×™×ª:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                        </div>

                        <button id="saveShulBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 shadow-md">×©××•×¨ ×‘×™×ª ×›× ×¡×ª</button>
                    </div>
                </div>
                
                <div class="lg:col-span-2" id="shulsListContainer">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full">
                        <h3 class="font-bold text-lg mb-4">×¨×©×™××ª ×‘×ª×™ ×”×›× ×¡×ª</h3>
                        <div class="overflow-x-auto"><table class="w-full text-right text-sm"><thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-3">×©×</th><th class="p-3">×’×‘××™ ××•×¨×©×”</th><th class="p-3 text-center">×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="shulTableBody"><tr><td colspan="3" class="p-4 text-center text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="section-lessons" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-24">
                        <h3 class="font-bold text-lg text-blue-800 mb-4" id="lessonFormTitle">×”×•×¡×¤×ª ×©×™×¢×•×¨</h3>
                        <div class="mb-3">
                            <label class="text-xs font-bold text-gray-500">×©×™×™×š ×œ×‘×™×ª ×›× ×¡×ª</label>
                            <select id="lessonLocationSelect" class="w-full p-2 border rounded bg-green-50 font-bold focus:ring-2 ring-green-200"><option value="" disabled selected>×˜×•×¢×Ÿ ×¨×©×™××”...</option></select>
                        </div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×¨×‘</label><input type="text" id="lessonRabbi" class="w-full p-2 border rounded"></div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">× ×•×©×</label><select id="lessonTopic" class="w-full p-2 border rounded"><option value="gemara">×’××¨× / ×“×£ ×™×•××™</option><option value="halacha">×”×œ×›×”</option><option value="parasha">×¤×¨×©×ª ×©×‘×•×¢</option><option value="mussar">××•×¡×¨</option></select></div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×›×•×ª×¨×ª</label><input type="text" id="lessonTitle" class="w-full p-2 border rounded"></div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×™×•×</label><select id="lessonDay" class="w-full p-2 border rounded bg-blue-50"><option value="×›×œ ×™×•×">×›×œ ×™×•×</option><option value="×™×•× ×¨××©×•×Ÿ">×¨××©×•×Ÿ</option><option value="×™×•× ×©× ×™">×©× ×™</option><option value="×™×•× ×©×œ×™×©×™">×©×œ×™×©×™</option><option value="×™×•× ×¨×‘×™×¢×™">×¨×‘×™×¢×™</option><option value="×™×•× ×—××™×©×™">×—××™×©×™</option><option value="×™×•× ×©×™×©×™">×©×™×©×™</option><option value="××•×¦×´×©">××•×¦×´×©</option><option value="×©×‘×ª">×©×‘×ª</option></select></div>
                        <div class="mb-4">
                            <label class="text-xs font-bold text-gray-500">×–××Ÿ</label>
                            <div class="flex gap-2">
                                <select id="lessonTimeType" class="w-1/2 p-2 text-sm border rounded bg-slate-50"><option value="manual">ğŸ•’ ×©×¢×” ××“×•×™×§×ª</option><option value="××—×¨×™ ×× ×—×”">××—×¨×™ ×× ×—×”</option><option value="×œ×¤× ×™ ×× ×—×”">×œ×¤× ×™ ×× ×—×”</option><option value="××—×¨×™ ×¢×¨×‘×™×ª">××—×¨×™ ×¢×¨×‘×™×ª</option><option value="×œ×¤× ×™ ×¢×¨×‘×™×ª">×œ×¤× ×™ ×¢×¨×‘×™×ª</option><option value="××—×¨×™ ×©×—×¨×™×ª">××—×¨×™ ×©×—×¨×™×ª</option><option value="×œ×¤× ×™ ×©×—×¨×™×ª">×œ×¤× ×™ ×©×—×¨×™×ª</option></select>
                                <input type="time" id="lessonTimeClock" class="w-1/2 p-2 text-sm border rounded">
                            </div>
                        </div>
                        <button id="saveLessonBtn" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">×¤×¨×¡× ×©×™×¢×•×¨</button>
                        <button id="cancelLessonEditBtn" class="w-full mt-2 text-red-500 text-sm hidden">×‘×™×˜×•×œ</button>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full">
                        <h3 class="font-bold text-lg mb-4">×©×™×¢×•×¨×™× ×¤×¢×™×œ×™×</h3>
                        <div class="overflow-x-auto"><table class="w-full text-right text-sm"><thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-3">×‘×™×ª ×›× ×¡×ª</th><th class="p-3">×¨×‘ ×•×ª×•×›×Ÿ</th><th class="p-3">×–××Ÿ</th><th class="p-3">×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="lessonsTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, remove, get, onValue, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArvTHLvtHZwguLn0OpPMMJdqDKS7OnDOg",
            authDomain: "tirat-carmel-shul.firebaseapp.com",
            databaseURL: "https://tirat-carmel-shul-default-rtdb.firebaseio.com",
            projectId: "tirat-carmel-shul",
            storageBucket: "tirat-carmel-shul.firebasestorage.app",
            messagingSenderId: "645574971282",
            appId: "1:645574971282:web:9fb6720ea7c960ca37fb4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let tempTimes = { shacharit: [], mincha: [], arvit: [] };
        let editingShulId = null;
        let editingLessonId = null;
        let allShuls = [];
        let allLessons = {}; // ×××’×¨ ×©×™×¢×•×¨×™× ××§×•××™
        let isSuperAdmin = false;
        let currentGabbaiShulId = null;
        let currentGabbaiShulName = null; // ×©× ×‘×™×ª ×”×›× ×¡×ª ×©×œ ×”×’×‘××™

        // --- ×˜×¢×™× ×ª ×”×’×“×¨×•×ª