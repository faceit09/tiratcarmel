<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול בתי כנסת - גרסה יציבה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>body { font-family: 'Heebo', sans-serif; }</style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-blue-900">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-96 text-center border-t-8 border-yellow-500">
            <h2 class="text-3xl font-black mb-8 text-blue-900 underline">כניסת מנהל</h2>
            <input type="text" id="u" placeholder="שם משתמש" class="w-full mb-4 p-4 border rounded-2xl outline-none focus:ring-2 ring-blue-500 text-lg">
            <input type="password" id="p" placeholder="סיסמה" class="w-full mb-8 p-4 border rounded-2xl outline-none focus:ring-2 ring-blue-500 text-lg">
            <button id="loginBtn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xl hover:bg-blue-700 shadow-xl transition transform hover:scale-105">התחבר למערכת</button>
        </div>
    </div>

    <div id="dash" class="hidden">
        <nav class="bg-white shadow-md p-5 flex justify-between items-center sticky top-0 z-50 border-b-4 border-blue-600">
            <h1 class="text-2xl font-black text-blue-900">ניהול לוח בתי כנסת</h1>
            <button onclick="location.reload()" class="bg-red-500 text-white px-6 py-2 rounded-2xl font-bold hover:bg-red-600 transition">התנתק</button>
        </nav>

        <div class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-white p-8 rounded-[3rem] shadow-2xl border-t-8 border-blue-600 sticky top-24">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 id="formTitle" class="text-2xl font-black text-blue-900">הוספה / עדכון</h3>
                    <button id="cancelBtn" class="hidden text-red-500 font-bold underline hover:text-red-700">ביטול עריכה</button>
                </div>
                
                <div class="space-y-4">
                    <input type="text" id="shulName" placeholder="שם בית הכנסת" class="w-full p-3 border rounded-xl font-bold bg-blue-50 focus:bg-white transition">
                    <div class="flex gap-2">
                        <input type="text" id="shulNickname" placeholder="כינוי" class="w-1/2 p-3 border rounded-xl text-sm">
                        <input type="text" id="shulAddress" placeholder="כתובת" class="w-1/2 p-3 border rounded-xl text-sm">
                    </div>
                    
                    <div id="gabbaiAuth" class="bg-yellow-50 p-4 rounded-2xl border border-yellow-200 hidden">
                        <label class="block text-xs font-bold text-yellow-800 mb-2">פרטי גישה לגבאי:</label>
                        <div class="flex gap-2">
                            <input type="text" id="gUser" placeholder="יוזר" class="w-1/2 p-2 border rounded text-xs">
                            <input type="text" id="gPass" placeholder="סיסמה" class="w-1/2 p-2 border rounded text-xs">
                        </div>
                    </div>

                    <textarea id="shulMessage" rows="2" placeholder="הודעה חשובה..." class="w-full p-3 border rounded-xl text-sm"></textarea>
                    <div class="flex gap-2">
                        <textarea id="shulRefuah" rows="2" placeholder="לרפואה..." class="w-1/2 p-2 border rounded-xl text-xs"></textarea>
                        <textarea id="shulNishmat" rows="2" placeholder="לעילוי נשמת..." class="w-1/2 p-2 border rounded-xl text-xs"></textarea>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-3xl border border-slate-200">
                        <label class="block text-xs font-black mb-3 text-blue-800 underline">🕒 ניהול זמני תפילה:</label>
                        <div class="flex gap-2 mb-3">
                            <select id="tDay" class="w-1/2 p-2 border rounded-lg text-sm font-bold"><option value="חול">חול</option><option value="יום א׳">יום א׳</option><option value="יום ב׳">יום ב׳</option><option value="יום ג׳">יום ג׳</option><option value="יום ד׳">יום ד׳</option><option value="יום ה׳">יום ה׳</option><option value="יום ו׳">יום ו׳</option><option value="שבת">שבת</option><option value="מוצ״ש">מוצ״ש</option></select>
                            <select id="tType" class="w-1/2 p-2 border rounded-lg text-sm font-bold"><option value="שחרית">שחרית</option><option value="מנחה">מנחה</option><option value="ערבית">ערבית</option></select>
                        </div>
                        
                        <select id="tMode" onchange="toggleInputs()" class="w-full p-2 border rounded-lg text-sm mb-3 bg-white">
                            <option value="manual">שעה ידנית (למשל 08:00)</option>
                            <option value="before_sunset">⏳ דקות לפני שקיעה</option>
                            <option value="before_candles">🕯️ דקות לפני כניסת שבת</option>
                            <option value="before_exit_shabbat">✨ דקות לפני צאת שבת</option>
                            <option value="stars">⭐ צאת הכוכבים</option>
                            <option value="sunrise">☀️ הנץ החמה</option>
                        </select>

                        <div class="flex gap-2 mb-2">
                            <input type="text" id="tVal" placeholder="הזן שעה או דקות..." class="flex-grow p-2 border rounded-lg text-sm">
                            <button onclick="addTime()" class="bg-green-600 text-white px-4 rounded-lg font-black shadow hover:bg-green-700">+</button>
                        </div>
                        <div id="tList" class="mt-2 space-y-1 max-h-40 overflow-y-auto bg-white p-2 rounded-xl border"></div>
                    </div>

                    <div class="bg-orange-50 p-4 rounded-3xl border border-orange-200">
                        <label class="block text-xs font-black mb-2 text-orange-900">📚 שיעורי תורה:</label>
                        <div class="flex gap-1 mb-2">
                            <input type="text" id="lRabbi" placeholder="הרב" class="w-1/3 p-2 border rounded text-xs">
                            <input type="text" id="lTopic" placeholder="נושא" class="w-1/3 p-2 border rounded text-xs">
                            <input type="text" id="lTime" placeholder="זמן" class="w-1/3 p-2 border rounded text-xs">
                        </div>
                        <button onclick="addLess()" class="w-full bg-orange-600 text-white py-2 rounded-xl font-bold text-xs hover:bg-orange-700">הוסף שיעור לרשימה</button>
                        <div id="lList" class="mt-2 space-y-1 max-h-32 overflow-y-auto bg-white p-2 rounded-xl border"></div>
                    </div>

                    <button id="saveBtn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xl shadow-xl hover:bg-blue-700 transition transform hover:scale-105">שמור הכל</button>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-8 rounded-[30px] shadow-2xl h-full border border-slate-200">
                    <h3 class="text-2xl font-black text-blue-900 border-b-2 border-blue-50 pb-4 mb-8">בתי כנסת במערכת:</h3>
                    <div id="shulList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-full text-center text-slate-400 py-20 italic">טוען נתונים...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArvTHLvtHZwguLn0OpPMMJdqDKS7OnDOg",
            authDomain: "tirat-carmel-shul.firebaseapp.com",
            databaseURL: "https://tirat-carmel-shul-default-rtdb.firebaseio.com",
            projectId: "tirat-carmel-shul",
            storageBucket: "tirat-carmel-shul.firebasestorage.app",
            messagingSenderId: "645574971282",
            appId: "1:645574971282:web:9fb6720ea7c960ca37fb4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let tempT = [], tempL = [], editId = null, isAdmin = false;

        document.getElementById('loginBtn').onclick = async () => {
            const u = document.getElementById('u').value.trim();
            const p = document.getElementById('p').value.trim();
            
            if(u === 'admin' && p === '1234') {
                isAdmin = true;
                showDash();
                document.getElementById('gabbaiAuth').classList.remove('hidden');
                loadList();
                return;
            }

            // כניסת גבאי
            const snap = await get(child(ref(db), `users/${u}`));
            if(snap.exists() && snap.val().password === p) {
                isAdmin = false;
                editId = snap.val().shulId;
                showDash();
                // טוען את הנתונים של הגבאי הספציפי
                const sSnap = await get(child(ref(db), `prayers/${editId}`));
                if(sSnap.exists()) loadEdit(editId, sSnap.val());
                document.getElementById('shulList').parentElement.classList.add('hidden'); // מסתיר רשימה לגבאי
            } else {
                alert("פרטים שגויים");
            }
        };

        function showDash() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dash').classList.remove('hidden');
        }

        // ניהול שדה הקלט לפי סוג הזמן
        window.toggleInputs = () => {
            const m = document.getElementById('tMode').value;
            const inp = document.getElementById('tVal');
            if(m === 'manual') inp.placeholder = "שעה (למשל 08:00)";
            else if(m.includes('before')) inp.placeholder = "כמה דקות לפני?";
            else { inp.placeholder = "מחושב אוטומטית"; inp.value = ""; }
        };

        window.addTime = () => {
            const d = document.getElementById('tDay').value;
            const t = document.getElementById('tType').value;
            const m = document.getElementById('tMode').value;
            let val = document.getElementById('tVal').value;
            
            let finalVal = "";
            if(m === 'manual') finalVal = val;
            else if(m === 'before_sunset') finalVal = val + " דק' לפני שקיעה";
            else if(m === 'before_candles') finalVal = val + " דק' לפני כניסת שבת";
            else if(m === 'before_exit_shabbat') finalVal = val + " דק' לפני צאת שבת";
            else finalVal = {stars:"צאת הכוכבים", sunrise:"הנץ"}[m];

            if(finalVal) { 
                tempT.push({day:d, type:t, val:finalVal}); 
                renderT(); 
                document.getElementById('tVal').value = "";
            }
        };

        window.addLess = () => {
            const r = document.getElementById('lRabbi').value;
            const tp = document.getElementById('lTopic').value;
            const tm = document.getElementById('lTime').value;
            if(r && tp) { 
                tempL.push({rabbi:r, topic:tp, time:tm}); 
                renderT(); 
                document.getElementById('lRabbi').value=""; 
                document.getElementById('lTopic').value=""; 
                document.getElementById('lTime').value=""; 
            }
        };

        function renderT() {
            const tD = document.getElementById('tList');
            const lD = document.getElementById('lList');
            tD.innerHTML = ""; lD.innerHTML = "";
            
            tempT.forEach((t, i) => {
                tD.innerHTML += `<div class="flex justify-between bg-blue-50 p-2 rounded-lg text-xs border border-blue-100 mb-1">
                    <span><b>${t.day}</b> ${t.type}: ${t.val}</span>
                    <button onclick="remT(${i})" class="text-red-500 font-bold hover:bg-red-100 px-2 rounded">X</button>
                </div>`;
            });

            tempL.forEach((l, i) => {
                lD.innerHTML += `<div class="flex justify-between bg-orange-50 p-2 rounded-lg text-xs border border-orange-100 mb-1">
                    <span>${l.rabbi}: ${l.topic} (${l.time})</span>
                    <button onclick="remL(${i})" class="text-red-500 font-bold hover:bg-red-100 px-2 rounded">X</button>
                </div>`;
            });
        }

        window.remT = (i) => { tempT.splice(i,1); renderT(); };
        window.remL = (i) => { tempL.splice(i,1); renderT(); };

        document.getElementById('saveBtn').onclick = () => {
            const name = document.getElementById('shulName').value;
            if(!name) return alert("חובה להזין שם");

            // פילטר ליצירת מחרוזות לתצוגה באתר
            const format = (isShab, type) => tempT.filter(t => (isShab ? (t.day==='שבת'||t.day==='מוצ״ש') : (t.day!=='שבת'&&t.day!=='מוצ״ש')) && t.type===type).map(t => (t.day==='חול'?'':t.day+' ')+t.val).join(', ');

            const data = {
                name: name,
                nickname: document.getElementById('shulNickname').value,
                address: document.getElementById('shulAddress').value,
                message: document.getElementById('shulMessage').value,
                refuahNames: document.getElementById('shulRefuah').value,
                iluiNishmatNames: document.getElementById('shulNishmat').value,
                // שדות מחושבים לאתר
                shacharit_chol: format(false,'שחרית'),
                mincha_chol: format(false,'מנחה'),
                arvit_chol: format(false,'ערבית'),
                shacharit_shabbat: format(true,'שחרית'),
                mincha_shabbat: format(true,'מנחה'),
                arvit_shabbat: format(true,'ערבית'),
                // שדות גולמיים לעריכה חוזרת
                rawTimes: tempT,
                lessons: tempL,
                // פרטי גבאי
                sUser: document.getElementById('gUser').value,
                sPass: document.getElementById('gPass').value
            };

            const refPath = editId ? ref(db, `prayers/${editId}`) : push(ref(db, 'prayers'));
            set(refPath, data).then(() => {
                // אם נוצר יוזר לגבאי, שומר אותו גם בטבלת יוזרים
                if(isAdmin && data.sUser && data.sPass) {
                    set(ref(db, `users/${data.sUser}`), { password: data.sPass, shulId: refPath.key });
                }
                alert("נשמר בהצלחה!");
                if(isAdmin) { location.reload(); } // רענון למנהל כדי לראות ברשימה
            });
        };

        function loadList() {
            onValue(ref(db, 'prayers'), (snap) => {
                const c = document.getElementById('shulList');
                c.innerHTML = "";
                const val = snap.val();
                if(val) {
                    Object.entries(val).forEach(([id, v]) => {
                        const d = document.createElement('div');
                        d.className = "bg-slate-50 p-5 rounded-3xl border border-slate-200 flex justify-between items-center hover:shadow-lg transition cursor-pointer";
                        d.innerHTML = `
                            <div>
                                <b class="text-blue-900 text-lg">${v.name}</b>
                                <div class="text-xs text-slate-500">${v.nickname || ''}</div>
                            </div>
                            <div class="flex gap-2">
                                <button class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold edit-btn">ערוך</button>
                                <button class="bg-red-100 text-red-500 px-3 py-2 rounded-xl text-xs font-bold del-btn"><i class="fas fa-trash"></i></button>
                            </div>`;
                        
                        d.querySelector('.edit-btn').onclick = () => loadEdit(id, v);
                        d.querySelector('.del-btn').onclick = () => { if(confirm("למחוק?")) remove(ref(db, `prayers/${id}`)); };
                        c.appendChild(d);
                    });
                } else {
                    c.innerHTML = "<div class='col-span-full text-center py-10 text-slate-400'>אין בתי כנסת להצגה</div>";
                }
            });
        }

        function loadEdit(id, v) {
            editId = id;
            // טעינת שדות טקסט
            document.getElementById('shulName').value = v.name || "";
            document.getElementById('shulNickname').value = v.nickname || "";
            document.getElementById('shulAddress').value = v.address || "";
            document.getElementById('shulMessage').value = v.message || "";
            document.getElementById('shulRefuah').value = v.refuahNames || "";
            document.getElementById('shulNishmat').value = v.iluiNishmatNames || "";
            document.getElementById('gUser').value = v.sUser || "";
            document.getElementById('gPass').value = v.sPass || "";

            // טעינת מערכים (התיקון החשוב!)
            tempT = v.rawTimes ? [...v.rawTimes] : [];
            tempL = v.lessons ? [...v.lessons] : [];
            
            renderT();
            
            document.getElementById('formTitle').innerText = "עריכת: " + v.name;
            document.getElementById('saveBtn').innerText = "עדכן נתונים";
            document.getElementById('cancelBtn').classList.remove('hidden');
            window.scrollTo({top:0, behavior:'smooth'});
        }

        document.getElementById('cancelBtn').onclick = () => location.reload();

    </script>
</body>
</html>