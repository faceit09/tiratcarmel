<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××¢×¨×›×ª - ×’×‘××™ (××•× ×œ×™×™×Ÿ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .nav-btn { background-color: white; color: #4b5563; }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-blue-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <div class="mb-4 text-blue-600 text-5xl"><i class="fas fa-synagogue"></i></div>
            <h2 class="text-2xl font-bold mb-4">×›× ×™×¡×ª ×’×‘××™ / ×× ×”×œ</h2>
            <input type="text" id="username" placeholder="×©× ××©×ª××©" class="w-full mb-3 p-3 border rounded-lg bg-gray-50">
            <input type="password" id="password" placeholder="×¡×™×¡××”" class="w-full mb-6 p-3 border rounded-lg bg-gray-50">
            <button id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">×”×›× ×¡ ×œ××¢×¨×›×ª</button>
            <p id="error-msg" class="text-red-500 text-sm mt-3 hidden">×¤×¨×˜×™× ×©×’×•×™×™×</p>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden min-h-screen pb-20">
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center text-blue-900 font-bold text-xl">
                <i class="fas fa-cloud ml-2"></i> <span id="navTitle">×˜×•×¢×Ÿ...</span>
            </div>
            <button id="logoutBtn" class="text-red-500 text-sm hover:bg-red-50 px-3 py-1 rounded font-bold border border-red-200">×”×ª× ×ª×§</button>
        </nav>

        <div class="container mx-auto p-6">
            
            <div id="globalSettingsPanel" class="bg-indigo-50 border border-indigo-200 p-4 rounded-xl mb-6 hidden">
                <h3 class="font-bold text-indigo-900 mb-3"><i class="fas fa-clock ml-2"></i>×”×’×“×¨×•×ª ×–×× ×™× ×’×œ×•×‘×œ×™×•×ª (×“×§×•×ª)</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-xs">
                    <div><label class="block mb-1">×›× ×™×¡×ª ×©×‘×ª (+)</label><input type="number" id="setting_entry" class="w-full p-2 border rounded"></div>
                    <div><label class="block mb-1">×™×¦×™××ª ×©×‘×ª (+)</label><input type="number" id="setting_exit" class="w-full p-2 border rounded"></div>
                    <div><label class="block mb-1">×¢×œ×•×ª ×”×©×—×¨ (+)</label><input type="number" id="setting_alot" class="w-full p-2 border rounded"></div>
                    <div><label class="block mb-1">×˜×œ×™×ª/×ª×¤×™×œ×™×Ÿ (-)</label><input type="number" id="setting_talit" class="w-full p-2 border rounded"></div>
                    <div><label class="block mb-1">×¦××ª ×”×›×•×›×‘×™× (-)</label><input type="number" id="setting_tzeit" class="w-full p-2 border rounded"></div>
                </div>
                <button id="saveSettingsBtn" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded font-bold text-xs">×©××•×¨ ×”×’×“×¨×•×ª ×–×× ×™×</button>
            </div>

            <div id="section-prayers" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1" id="editFormContainer">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 sticky top-24">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-green-700" id="formTitle">×”×•×¡×¤×ª ×‘×™×ª ×›× ×¡×ª</h3>
                            <button id="cancelEditBtn" class="hidden text-xs text-red-500 hover:bg-red-100 p-1 rounded">×‘×™×˜×•×œ / ×—×“×©</button>
                        </div>
                        
                        <div id="authFields" class="bg-yellow-50 p-3 rounded border border-yellow-200 mb-4 hidden">
                            <label class="block text-xs font-bold mb-1">ğŸ”‘ ×”×’×“×¨×ª ×’×‘××™ ×œ× ×™×”×•×œ ×¢×¦××™:</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="shulUser" placeholder="×©× ××©×ª××©" class="p-2 border rounded text-sm w-full">
                                <input type="text" id="shulPass" placeholder="×¡×™×¡××”" class="p-2 border rounded text-sm w-full">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input type="text" id="shulName" placeholder="×©× ×‘×™×ª ×”×›× ×¡×ª" class="p-2 border rounded text-sm w-full">
                            <input type="text" id="shulNickname" placeholder="×›×™× ×•×™ (××•×¤×¦×™×•× ×œ×™)" class="p-2 border rounded text-sm w-full">
                        </div>

                        <textarea id="shulMessage" rows="2" class="w-full p-2 border rounded text-sm mb-2" placeholder="×”×•×“×¢×” ×—×©×•×‘×” ×œ××ª×¤×œ×œ×™×..."></textarea>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <textarea id="shulRefuah" rows="2" class="w-full p-2 border rounded text-sm" placeholder="×©××•×ª ×œ×¨×¤×•××”..."></textarea>
                            <textarea id="shulNishmat" rows="2" class="w-full p-2 border rounded text-sm" placeholder="×œ×¢×™×œ×•×™ × ×©××ª..."></textarea>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg border mb-4">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select id="timeType" class="p-2 text-sm border rounded"><option value="shacharit">×©×—×¨×™×ª</option><option value="mincha">×× ×—×”</option><option value="arvit">×¢×¨×‘×™×ª</option></select>
                                <select id="timeDay" class="p-2 text-sm border rounded">
                                    <option value="×—×•×œ">×™××™ ×—×•×œ</option>
                                    <option value="×™×•× ×¨××©×•×Ÿ">×™×•× ×¨××©×•×Ÿ</option><option value="×™×•× ×©× ×™">×™×•× ×©× ×™</option><option value="×™×•× ×©×œ×™×©×™">×™×•× ×©×œ×™×©×™</option><option value="×™×•× ×¨×‘×™×¢×™">×™×•× ×¨×‘×™×¢×™</option><option value="×™×•× ×—××™×©×™">×™×•× ×—××™×©×™</option><option value="×™×•× ×©×™×©×™">×™×•× ×©×™×©×™</option>
                                    <option value="×©×‘×ª">×©×‘×ª</option><option value="××•×¦×´×©">××•×¦×´×©</option>
                                </select>
                            </div>
                            <select id="timeMode" class="w-full p-2 text-sm border rounded mb-2">
                                <option value="manual">ğŸ•’ ×©×¢×” ××“×•×™×§×ª</option>
                                <option value="before_sunset">â³ ×“×§' ×œ×¤× ×™ ×©×§×™×¢×”</option>
                                <option value="before_exit_shabbat">â³ ×“×§' ×œ×¤× ×™ ×¦××ª ×©×‘×ª</option>
                                <option value="sunset">ğŸŒ… ×©×§×™×¢×”</option>
                                <option value="stars">âœ¨ ×¦××ª ×”×›×•×›×‘×™×</option>
                                <option value="candles">ğŸ•¯ï¸ ×›× ×™×¡×ª ×©×‘×ª</option>
                                <option value="exit_shabbat">â­ ×¦××ª ×©×‘×ª</option>
                                <option value="sunrise">â˜€ï¸ ×”× ×¥</option>
                            </select>
                            <div class="flex gap-2">
                                <input type="time" id="timeClock" class="p-2 border rounded flex-grow">
                                <input type="number" id="minutesInput" placeholder="×“×§×•×ª" class="hidden p-2 border rounded w-20">
                                <button id="addTimeBtn" class="bg-green-600 text-white px-4 rounded font-bold">×”×•×¡×£</button>
                            </div>
                        </div>

                        <div id="timesListContainer" class="space-y-2 mb-4">
                            <div id="list-shacharit" class="hidden text-[10px]"><b class="text-blue-800">×©×—×¨×™×ª:</b> <div class="flex flex-wrap content"></div></div>
                            <div id="list-mincha" class="hidden text-[10px]"><b class="text-orange-800">×× ×—×”:</b> <div class="flex flex-wrap content"></div></div>
                            <div id="list-arvit" class="hidden text-[10px]"><b class="text-indigo-800">×¢×¨×‘×™×ª:</b> <div class="flex flex-wrap content"></div></div>
                        </div>

                        <button id="saveShulBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 shadow-md">×©××•×¨ × ×ª×•× ×™ ×‘×™×ª ×›× ×¡×ª</button>
                    </div>
                </div>
                
                <div class="lg:col-span-2" id="shulsListContainer">
                    <div class="bg-white p-6 rounded-xl shadow-md border h-full">
                        <h3 class="font-bold text-lg mb-4 text-blue-900 border-b pb-2">×‘×ª×™ ×›× ×¡×ª ×§×™×™××™×</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead><tr class="bg-gray-50 border-b">
                                    <th class="p-3">×©×</th><th class="p-3">×›×™× ×•×™/×’×‘××™</th><th class="p-3 text-center">×¤×¢×•×œ×•×ª</th>
                                </tr></thead>
                                <tbody id="shulTableBody"><tr><td colspan="3" class="p-6 text-center text-gray-400 italic">××ª×—×‘×¨ ×œ× ×ª×•× ×™×...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, remove, get, onValue, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArvTHLvtHZwguLn0OpPMMJdqDKS7OnDOg",
            authDomain: "tirat-carmel-shul.firebaseapp.com",
            databaseURL: "https://tirat-carmel-shul-default-rtdb.firebaseio.com",
            projectId: "tirat-carmel-shul",
            storageBucket: "tirat-carmel-shul.firebasestorage.app",
            messagingSenderId: "645574971282",
            appId: "1:645574971282:web:9fb6720ea7c960ca37fb4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let tempTimes = { shacharit: [], mincha: [], arvit: [] };
        let editingShulId = null;
        let isSuperAdmin = false;
        let allShulsData = [];

        // ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×ª ×˜×‘×œ×” ×—×–×§×”
        function renderShulTable() {
            const tbody = document.getElementById('shulTableBody');
            if(!tbody || !isSuperAdmin) return;
            
            if (allShulsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-gray-500">××™×Ÿ ×‘×ª×™ ×›× ×¡×ª ×œ×”×¦×’×”.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            allShulsData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="p-3 font-bold text-blue-900">${item.name}</td>
                    <td class="p-3 text-gray-500 text-xs">${item.nickname || '-'}</td>
                    <td class="p-3 text-center">
                        <button class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-600 hover:text-white transition">×¢×¨×•×š</button>
                        <button class="bg-red-50 text-red-500 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-500 hover:text-white transition mr-1">××—×§</button>
                    </td>
                `;
                const btns = tr.querySelectorAll('button');
                btns[0].onclick = () => loadShulForEdit(item.id, item);
                btns[1].onclick = () => confirm(`×œ××—×•×§ ××ª ${item.name}?`) && remove(ref(db, 'prayers/' + item.id));
                tbody.appendChild(tr);
            });
        }

        // ×”××–× ×” ×§×‘×•×¢×” ×œ× ×ª×•× ×™×
        onValue(ref(db, 'prayers'), (snapshot) => {
            const data = snapshot.val();
            allShulsData = data ? Object.entries(data).map(([id, val]) => ({id, ...val})) : [];
            if (isSuperAdmin) renderShulTable();
        });

        // ×œ×•×’×™×Ÿ
        document.getElementById('loginBtn').onclick = async () => {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            
            if (user === 'admin' && pass === '1234') {
                isSuperAdmin = true;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                document.getElementById('authFields').classList.remove('hidden'); 
                document.getElementById('globalSettingsPanel').classList.remove('hidden');
                document.getElementById('navTitle').innerText = "×× ×”×œ ××¢×¨×›×ª";
                renderShulTable();
                return;
            }

            // ×œ×•×’×™×Ÿ ×’×‘××™
            const snapshot = await get(child(ref(db), `users/${user}`));
            if (snapshot.exists() && snapshot.val().password === pass) {
                isSuperAdmin = false;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                document.getElementById('shulsListContainer').classList.add('hidden');
                document.getElementById('section-prayers').classList.replace('lg:grid-cols-3', 'grid-cols-1');
                document.getElementById('editFormContainer').classList.replace('lg:col-span-1', 'lg:col-span-3');
                document.getElementById('navTitle').innerText = `×©×œ×•×, ${user}`;
                loadSingleShulForGabbai(snapshot.val().shulId);
            } else { alert("×¤×¨×˜×™× ×©×’×•×™×™×"); }
        };

        async function loadSingleShulForGabbai(id) {
            const s = await get(child(ref(db), `prayers/${id}`));
            if (s.exists()) loadShulForEdit(id, s.val());
        }

        document.getElementById('logoutBtn').onclick = () => location.reload();

        // ×œ×•×’×™×§×ª ×”×•×¡×¤×ª ×–××Ÿ
        document.getElementById('timeMode').onchange = () => {
            const mode = document.getElementById('timeMode').value;
            document.getElementById('timeClock').classList.toggle('hidden', mode !== 'manual');
            document.getElementById('minutesInput').classList.toggle('hidden', !mode.includes('before_'));
        };

        document.getElementById('addTimeBtn').onclick = () => {
            const type = document.getElementById('timeType').value;
            const day = document.getElementById('timeDay').value;
            const mode = document.getElementById('timeMode').value;
            let val = "";
            if (mode === 'manual') val = document.getElementById('timeClock').value;
            else if (mode === 'before_sunset') val = `${document.getElementById('minutesInput').value} ×“×§' ×œ×¤× ×™ ×©×§×™×¢×”`;
            else if (mode === 'before_exit_shabbat') val = `${document.getElementById('minutesInput').value} ×“×§' ×œ×¤× ×™ ×¦××ª ×©×‘×ª`;
            else val = { 'sunset': '×©×§×™×¢×”', 'stars': '×¦××ª ×”×›×•×›×‘×™×', 'exit_shabbat': '×¦××ª ×©×‘×ª', 'candles': '×›× ×™×¡×ª ×©×‘×ª', 'sunrise': '×”× ×¥' }[mode];

            if(!val) return alert("×‘×—×¨ ×–××Ÿ ×ª×§×™×Ÿ");
            tempTimes[type].push({ day, time: val });
            renderTempTimes();
        };

        function renderTempTimes() {
            ['shacharit', 'mincha', 'arvit'].forEach(type => {
                const container = document.querySelector(`#list-${type} .content`);
                container.innerHTML = '';
                if (tempTimes[type].length > 0) {
                    document.getElementById(`list-${type}`).classList.remove('hidden');
                    tempTimes[type].forEach((item, index) => {
                        const tag = document.createElement('div');
                        tag.className = 'bg-gray-100 p-1 px-2 rounded m-1 flex items-center border';
                        tag.innerHTML = `<span class="font-bold">${item.day}:</span> <span class="mr-1">${item.time}</span><button class="text-red-500 ml-2 font-bold">Ã—</button>`;
                        tag.querySelector('button').onclick = () => { tempTimes[type].splice(index, 1); renderTempTimes(); };
                        container.appendChild(tag);
                    });
                } else { document.getElementById(`list-${type}`).classList.add('hidden'); }
            });
        }

        document.getElementById('saveShulBtn').onclick = () => {
            const name = document.getElementById('shulName').value.trim();
            if(!name) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ×‘×™×ª ×›× ×¡×ª");
            
            const format = (list, isShabbatCol) => {
                const shabbatSet = ['×©×‘×ª', '×—×’', '××•×¦×´×©'];
                return list.filter(i => isShabbatCol ? shabbatSet.includes(i.day) : !shabbatSet.includes(i.day))
                    .map(i => `${i.day === '×—×•×œ' ? '' : i.day + ' '}${i.time}`).join(', ');
            };

            const data = {
                name, nickname: document.getElementById('shulNickname').value,
                message: document.getElementById('shulMessage').value,
                refuahNames: document.getElementById('shulRefuah').value,
                iluiNishmatNames: document.getElementById('shulNishmat').value,
                shacharit_chol: format(tempTimes.shacharit, false), mincha_chol: format(tempTimes.mincha, false), arvit_chol: format(tempTimes.arvit, false),
                shacharit_shabbat: format(tempTimes.shacharit, true), mincha_shabbat: format(tempTimes.mincha, true), arvit_shabbat: format(tempTimes.arvit, true),
                rawTimes: tempTimes
            };

            const shulRef = editingShulId ? ref(db, 'prayers/' + editingShulId) : push(ref(db, 'prayers'));
            set(shulRef, data).then(() => {
                if(isSuperAdmin && document.getElementById('shulUser').value) {
                    set(ref(db, 'users/' + document.getElementById('shulUser').value), { 
                        password: document.getElementById('shulPass').value, 
                        shulId: shulRef.key 
                    });
                }
                alert("×”× ×ª×•× ×™× × ×©××¨×• ×‘×‘×˜×—×”!");
                if (isSuperAdmin) location.reload();
            });
        };

        function loadShulForEdit(id, item) {
            editingShulId = id;
            document.getElementById('shulName').value = item.name;
            document.getElementById('shulNickname').value = item.nickname || '';
            document.getElementById('shulMessage').value = item.message || '';
            document.getElementById('shulRefuah').value = item.refuahNames || '';
            document.getElementById('shulNishmat').value = item.iluiNishmatNames || '';
            tempTimes = item.rawTimes || { shacharit: [], mincha: [], arvit: [] };
            renderTempTimes();
            document.getElementById('formTitle').innerText = "×¢×¨×™×›×ª: " + item.name;
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('cancelEditBtn').onclick = () => location.reload();
        
        document.getElementById('saveSettingsBtn').onclick = () => {
            const settings = {
                shabbatEntry: parseInt(document.getElementById('setting_entry').value),
                shabbatExit: parseInt(document.getElementById('setting_exit').value),
                alot: parseInt(document.getElementById('setting_alot').value),
                talit: parseInt(document.getElementById('setting_talit').value),
                tzeit: parseInt(document.getElementById('setting_tzeit').value)
            };
            set(ref(db, 'settings'), settings).then(() => alert('×”×’×“×¨×•×ª × ×©××¨×•!'));
        };
    </script>
</body>
</html>