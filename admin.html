<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול מערכת - גבאי</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .nav-btn { background-color: white; color: #4b5563; }
        .time-tag { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-blue-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <div class="mb-4 text-blue-600 text-5xl"><i class="fas fa-synagogue"></i></div>
            <h2 class="text-2xl font-bold mb-4">ניהול בתי כנסת - טירת הכרמל</h2>
            <input type="text" id="username" placeholder="שם משתמש" class="w-full mb-3 p-3 border rounded-lg bg-gray-50">
            <input type="password" id="password" placeholder="סיסמה" class="w-full mb-6 p-3 border rounded-lg bg-gray-50">
            <button onclick="login()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">הכנס למערכת</button>
            <p id="error-msg" class="text-red-500 text-sm mt-3 hidden">פרטים שגויים</p>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden min-h-screen pb-20">
        
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center text-blue-900 font-bold text-xl">
                <i class="fas fa-tools ml-2"></i> פאנל גבאי
            </div>
            <button onclick="logout()" class="text-red-500 text-sm hover:bg-red-50 px-3 py-1 rounded">התנתק</button>
        </nav>

        <div class="container mx-auto mt-6 px-4 flex justify-center gap-4">
            <button onclick="switchSection('prayers')" id="btn-prayers" class="nav-btn active px-6 py-2 rounded-full font-bold shadow-sm transition">
                <i class="fas fa-synagogue ml-2"></i>ניהול בתי כנסת
            </button>
            <button onclick="switchSection('lessons')" id="btn-lessons" class="nav-btn px-6 py-2 rounded-full font-bold shadow-sm transition">
                <i class="fas fa-book-open ml-2"></i>ניהול שיעורים
            </button>
        </div>

        <div class="container mx-auto p-6">
            
            <div id="section-prayers" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-24 overflow-y-auto max-h-[90vh]">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-green-700" id="formTitle">הוספת בית כנסת</h3>
                            <button onclick="cancelEdit()" id="cancelEditBtn" class="hidden text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded">ביטול עריכה</button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-xs font-bold text-gray-500">שם בית הכנסת</label>
                            <input list="tc-shuls" id="shulName" class="w-full p-2 border rounded focus:ring-2 ring-green-200" placeholder="הקלד שם..." required>
                            <datalist id="tc-shuls"><option value="היכל אהרון"><option value="אם הבנים"><option value="בית תנחום"><option value="ישורון"><option value="הרמב״ם"><option value="בית חב״ד"><option value="אוהל יצחק"></datalist>
                        </div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">כתובת לניווט</label><input type="text" id="shulAddress" placeholder="כתובת..." class="w-full p-2 border rounded"></div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs font-bold text-gray-500">נוסח</label><select id="shulNusach" class="w-full p-2 border rounded bg-slate-50"><option value="עדות המזרח">עדות המזרח</option><option value="ספרד">ספרד</option><option value="אשכנז">אשכנז</option><option value="תימן">תימן</option><option value="חב״ד">חב״ד</option><option value="מרוקאי">מרוקאי</option><option value="אחיד">אחיד</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">רב</label><input type="text" id="shulRabbi" placeholder="שם הרב" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="mb-4"><label class="text-xs font-bold text-gray-500">גבאי</label><input type="text" id="shulGabbai" placeholder="שם הגבאי" class="w-full p-2 border rounded"></div>

                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                            <label class="block text-xs font-bold text-gray-700 mb-2">📅 הגדרת זמנים לתפילות</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select id="timeType" class="p-2 text-sm border rounded"><option value="shacharit">שחרית</option><option value="mincha">מנחה</option><option value="arvit">ערבית</option></select>
                                <select id="timeDay" class="p-2 text-sm border rounded"><option value="chol">ימי חול</option><option value="Sunday">ראשון</option><option value="Friday">שישי</option><option value="Motzash">מוצ"ש</option><option disabled>──</option><option value="shabbat">שבת</option><option value="chag">חג</option></select>
                            </div>
                            <div class="mb-2">
                                <select id="timeMode" onchange="toggleTimeInput()" class="w-full p-2 text-sm border rounded bg-blue-50 text-blue-900 font-medium">
                                    <option value="manual">🕒 שעה מדויקת</option>
                                    <option value="before_sunset">⏳ דקות לפני שקיעה</option> <option value="sunset">🌅 שקיעה</option>
                                    <option value="stars">✨ צאת הכוכבים</option>
                                    <option value="candles">🕯️ כניסת שבת</option>
                                    <option value="sunrise">☀️ הנץ החמה</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <input type="time" id="timeClock" class="p-2 text-sm border rounded flex-grow">
                                <input type="number" id="minutesInput" placeholder="דקות" class="hidden p-2 text-sm border rounded w-20 flex-grow">
                                
                                <button type="button" onclick="addTimeToList()" class="bg-green-600 text-white px-4 rounded hover:bg-green-700 font-bold"><i class="fas fa-plus"></i> הוסף</button>
                            </div>
                        </div>

                        <div id="timesListContainer" class="space-y-2 mb-4 text-sm">
                            <div id="list-shacharit" class="hidden border-r-2 border-yellow-400 pr-2"><span class="font-bold text-xs text-yellow-700 block">שחרית:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                            <div id="list-mincha" class="hidden border-r-2 border-orange-400 pr-2"><span class="font-bold text-xs text-orange-700 block">מנחה:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                            <div id="list-arvit" class="hidden border-r-2 border-blue-400 pr-2"><span class="font-bold text-xs text-blue-700 block">ערבית:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                        </div>

                        <button onclick="saveShulWithTimes()" id="saveBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 shadow-md">שמור בית כנסת</button>
                    </div>
                </div>
                
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full">
                        <h3 class="font-bold text-lg mb-4">רשימת בתי הכנסת</h3>
                        <div class="overflow-x-auto"><table class="w-full text-right text-sm"><thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-3">שם</th><th class="p-3">פרטים</th><th class="p-3 text-center">פעולות</th></tr></thead><tbody id="shulTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="section-lessons" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-24">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-blue-800" id="lessonFormTitle">הוספת שיעור</h3>
                            <button onclick="cancelEditLesson()" id="cancelLessonEditBtn" class="hidden text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded">ביטול עריכה</button>
                        </div>
                        <form id="addLessonForm" onsubmit="addLesson(event)">
                            <div class="mb-3">
                                <label class="text-xs font-bold text-gray-500">שייך לבית כנסת</label>
                                <select id="lessonLocationSelect" class="w-full p-2 border rounded bg-green-50 font-bold focus:ring-2 ring-green-200">
                                    <option value="" disabled selected>בחר בית כנסת מהרשימה...</option>
                                </select>
                            </div>

                            <div class="mb-3"><label class="text-xs font-bold text-gray-500">שם הרב</label><input type="text" id="rabbiName" required class="w-full p-2 border rounded"></div>
                            <div class="mb-3"><label class="text-xs font-bold text-gray-500">נושא</label><select id="topic" class="w-full p-2 border rounded"><option value="gemara">גמרא / דף יומי</option><option value="halacha">הלכה</option><option value="parasha">פרשת שבוע</option><option value="mussar">מוסר</option></select></div>
                            <div class="mb-3"><label class="text-xs font-bold text-gray-500">כותרת</label><input type="text" id="title" placeholder="נושא השיעור" required class="w-full p-2 border rounded"></div>
                            
                            <div class="mb-3">
                                <label class="text-xs font-bold text-gray-500">יום</label>
                                <select id="day" class="w-full p-2 border rounded bg-blue-50">
                                    <option value="כל יום">כל יום</option>
                                    <option value="יום ראשון">ראשון</option>
                                    <option value="יום שני">שני</option>
                                    <option value="יום שלישי">שלישי</option>
                                    <option value="יום רביעי">רביעי</option>
                                    <option value="יום חמישי">חמישי</option>
                                    <option value="יום שישי">שישי</option>
                                    <option value="מוצ״ש">מוצ״ש</option>
                                    <option value="שבת">שבת</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="text-xs font-bold text-gray-500">זמן השיעור</label>
                                <div class="flex gap-2">
                                    <select id="lessonTimeType" onchange="toggleLessonTimeInput()" class="w-1/2 p-2 text-sm border rounded bg-slate-50">
                                        <option value="manual">🕒 שעה מדויקת</option>
                                        <option value="אחרי מנחה">אחרי מנחה</option>
                                        <option value="לפני מנחה">לפני מנחה</option>
                                        <option value="אחרי ערבית">אחרי ערבית</option>
                                        <option value="לפני ערבית">לפני ערבית</option>
                                        <option value="אחרי שחרית">אחרי שחרית</option>
                                        <option value="לפני שחרית">לפני שחרית</option>
                                    </select>
                                    <input type="time" id="lessonTimeClock" class="w-1/2 p-2 text-sm border rounded">
                                </div>
                            </div>

                            <button type="submit" id="saveLessonBtn" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">פרסם שיעור</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full">
                        <h3 class="font-bold text-lg mb-4">שיעורים פעילים</h3>
                        <div class="overflow-x-auto"><table class="w-full text-right text-sm"><thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-3">בית כנסת</th><th class="p-3">רב ותוכן</th><th class="p-3">זמן</th><th class="p-3">פעולות</th></tr></thead><tbody id="lessonsTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function login() {
            if (document.getElementById('username').value === 'admin' && document.getElementById('password').value === '1234') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                loadAllData();
            } else { document.getElementById('error-msg').classList.remove('hidden'); }
        }
        function logout() { location.reload(); }
        function switchSection(section) {
            document.getElementById('section-lessons').classList.add('hidden');
            document.getElementById('section-prayers').classList.add('hidden');
            document.getElementById('btn-lessons').classList.remove('active');
            document.getElementById('btn-prayers').classList.remove('active');
            document.getElementById('section-' + section).classList.remove('hidden');
            document.getElementById('btn-' + section).classList.add('active');
        }

        // --- בתי כנסת ---
        const PRAYERS_KEY = 'torah_app_prayers';
        let tempTimes = { shacharit: [], mincha: [], arvit: [] };
        let editingShulId = null; 

        function toggleTimeInput() {
            const mode = document.getElementById('timeMode').value;
            const clock = document.getElementById('timeClock');
            const minutesInput = document.getElementById('minutesInput');

            // איפוס שדות
            clock.classList.add('hidden');
            minutesInput.classList.add('hidden');

            if (mode === 'manual') {
                clock.classList.remove('hidden');
                clock.classList.add('flex-grow');
            } else if (mode === 'before_sunset') {
                minutesInput.classList.remove('hidden');
                minutesInput.classList.add('flex-grow');
            }
        }

        function addTimeToList() {
            const type = document.getElementById('timeType').value;
            const day = document.getElementById('timeDay').value;
            const mode = document.getElementById('timeMode').value;
            let timeValue = "";

            if (mode === 'manual') {
                const clockVal = document.getElementById('timeClock').value;
                if (!clockVal) { alert('אנא בחר שעה'); return; }
                timeValue = clockVal;
            } else if (mode === 'before_sunset') {
                const mins = document.getElementById('minutesInput').value;
                if (!mins) { alert('אנא הזן מספר דקות'); return; }
                timeValue = `${mins} דק' לפני שקיעה`;
            } else {
                const map = { 'sunset': 'שקיעה', 'stars': 'צאת הכוכבים', 'sunrise': 'הנץ', 'candles': 'כניסת שבת' };
                timeValue = map[mode];
            }

            tempTimes[type].push({ day: day, time: timeValue });
            renderTempTimes();
        }

        function renderTempTimes() {
            ['shacharit', 'mincha', 'arvit'].forEach(type => {
                const container = document.querySelector(`#list-${type} .content`);
                const parent = document.getElementById(`list-${type}`);
                container.innerHTML = '';
                if (tempTimes[type].length > 0) {
                    parent.classList.remove('hidden');
                    tempTimes[type].forEach((item, index) => {
                        const tag = document.createElement('div');
                        tag.className = 'time-tag bg-gray-100 border border-gray-300 rounded px-2 py-1 text-xs flex items-center gap-2';
                        tag.innerHTML = `<span>${translateDay(item.day)} <b>${item.time}</b></span> <button onclick="removeTempTime('${type}', ${index})" class="text-red-500 font-bold">×</button>`;
                        container.appendChild(tag);
                    });
                } else { parent.classList.add('hidden'); }
            });
        }

        function translateDay(d) {
            const map = { 'chol': 'חול', 'shabbat': 'שבת', 'chag': 'חג', 'Sunday': 'א\'', 'Monday': 'ב\'', 'Tuesday': 'ג\'', 'Wednesday': 'ד\'', 'Thursday': 'ה\'', 'Friday': 'ו\'', 'Motzash': 'מוצ"ש' };
            return map[d] || d;
        }
        function reverseDay(label) {
            const map = { 'חול': 'chol', 'שבת': 'shabbat', 'חג': 'chag', 'א\'': 'Sunday', 'ב\'': 'Monday', 'ג\'': 'Tuesday', 'ד\'': 'Wednesday', 'ה\'': 'Thursday', 'ו\'': 'Friday', 'מוצ"ש': 'Motzash' };
            return map[label] || 'chol';
        }
        function removeTempTime(type, index) { tempTimes[type].splice(index, 1); renderTempTimes(); }

        function saveShulWithTimes() {
            const name = document.getElementById('shulName').value;
            if (!name) { alert('חובה שם'); return; }

            const isShabbatOrChag = (day) => day === 'shabbat' || day === 'chag';
            const dayPriority = { 'chol': 0, 'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 'Thursday': 5, 'Friday': 6, 'Motzash': 7, 'shabbat': 8, 'chag': 9 };

            const formatTimes = (list, isForShabbatCol) => {
                let filtered = list.filter(i => isForShabbatCol ? isShabbatOrChag(i.day) : !isShabbatOrChag(i.day));
                filtered.sort((a, b) => {
                    const rankA = dayPriority[a.day] !== undefined ? dayPriority[a.day] : 99;
                    const rankB = dayPriority[b.day] !== undefined ? dayPriority[b.day] : 99;
                    if (rankA !== rankB) return rankA - rankB;
                    return a.time.localeCompare(b.time);
                });
                return filtered.map(i => (i.day === 'chol' || i.day === 'shabbat') ? i.time : `${translateDay(i.day)} ${i.time}`).join(', ');
            };

            const newItem = {
                id: editingShulId ? editingShulId : Date.now(), 
                name: name,
                address: document.getElementById('shulAddress').value || '',
                nusach: document.getElementById('shulNusach').value,
                rabbi: document.getElementById('shulRabbi').value,
                gabbai: document.getElementById('shulGabbai').value,
                shacharit_chol: formatTimes(tempTimes.shacharit, false),
                mincha_chol: formatTimes(tempTimes.mincha, false),
                arvit_chol: formatTimes(tempTimes.arvit, false),
                shacharit_shabbat: formatTimes(tempTimes.shacharit, true),
                mincha_shabbat: formatTimes(tempTimes.mincha, true),
                arvit_shabbat: formatTimes(tempTimes.arvit, true),
            };

            let shuls = getShuls();
            if (editingShulId) {
                const index = shuls.findIndex(s => s.id === editingShulId);
                if (index !== -1) shuls[index] = newItem;
                alert('עודכן בהצלחה!');
            } else {
                shuls.push(newItem);
                alert('נוסף בהצלחה!');
            }
            saveShuls(shuls);
            cancelEdit(); 
        }

        function editShul(id) {
            const shuls = getShuls();
            const shul = shuls.find(s => s.id === id);
            if (!shul) return;

            editingShulId = id;
            document.getElementById('shulName').value = shul.name;
            document.getElementById('shulAddress').value = shul.address;
            document.getElementById('shulNusach').value = shul.nusach || 'עדות המזרח';
            document.getElementById('shulRabbi').value = shul.rabbi || '';
            document.getElementById('shulGabbai').value = shul.gabbai || '';

            document.getElementById('saveBtn').innerText = 'עדכן פרטי בית כנסת';
            document.getElementById('saveBtn').classList.replace('bg-blue-600', 'bg-orange-600');
            document.getElementById('saveBtn').classList.replace('hover:bg-blue-700', 'hover:bg-orange-700');
            document.getElementById('formTitle').innerText = 'עריכת בית כנסת';
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            tempTimes = { shacharit: [], mincha: [], arvit: [] };
            const parseString = (str, defaultType) => {
                if (!str) return [];
                return str.split(', ').map(part => {
                    const spaceIdx = part.indexOf(' ');
                    if (spaceIdx === -1) {
                        return { day: defaultType, time: part };
                    } else {
                        const dayLabel = part.substring(0, spaceIdx);
                        const time = part.substring(spaceIdx + 1);
                        return { day: reverseDay(dayLabel), time: time };
                    }
                });
            };

            tempTimes.shacharit.push(...parseString(shul.shacharit_chol, 'chol'));
            tempTimes.shacharit.push(...parseString(shul.shacharit_shabbat, 'shabbat'));
            tempTimes.mincha.push(...parseString(shul.mincha_chol, 'chol'));
            tempTimes.mincha.push(...parseString(shul.mincha_shabbat, 'shabbat'));
            tempTimes.arvit.push(...parseString(shul.arvit_chol, 'chol'));
            tempTimes.arvit.push(...parseString(shul.arvit_shabbat, 'shabbat'));

            renderTempTimes();
            document.querySelector('#section-prayers').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingShulId = null;
            document.getElementById('shulName').value = '';
            document.getElementById('shulAddress').value = '';
            document.getElementById('shulRabbi').value = '';
            document.getElementById('shulGabbai').value = '';
            tempTimes = { shacharit: [], mincha: [], arvit: [] };
            renderTempTimes();
            document.getElementById('saveBtn').innerText = 'שמור בית כנסת';
            document.getElementById('saveBtn').classList.replace('bg-orange-600', 'bg-blue-600');
            document.getElementById('saveBtn').classList.replace('hover:bg-orange-700', 'hover:bg-blue-700');
            document.getElementById('formTitle').innerText = 'הוספת בית כנסת';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        function getShuls() { return JSON.parse(localStorage.getItem(PRAYERS_KEY) || '[]'); }
        function saveShuls(data) { localStorage.setItem(PRAYERS_KEY, JSON.stringify(data)); loadShulTable(); updateLessonLocationOptions(); }
        function deleteShul(id) { if(confirm('למחוק?')) saveShuls(getShuls().filter(i => i.id !== id)); }
        
        function loadShulTable() {
            const tbody = document.getElementById('shulTableBody');
            tbody.innerHTML = '';
            getShuls().forEach(item => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-bold">${item.name}</td>
                        <td class="p-3 text-xs">
                           <div><span class="bg-gray-200 px-1 rounded text-[10px]">${item.nusach || '-'}</span></div>
                           <div class="mt-1"><b>רב:</b> ${item.rabbi || '-'}</div>
                        </td>
                        <td class="p-3 text-center">
                            <button onclick="editShul(${item.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded ml-1" title="ערוך"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteShul(${item.id})" class="text-red-500 hover:bg-red-50 p-2 rounded" title="מחק"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // --- שיעורים ---
        const LESSONS_KEY = 'torah_app_lessons';
        let editingLessonId = null;

        function getLessons() { return JSON.parse(localStorage.getItem(LESSONS_KEY) || '[]'); }
        function saveLessons(data) { localStorage.setItem(LESSONS_KEY, JSON.stringify(data)); loadLessonsTable(); }
        
        function toggleLessonTimeInput() {
            const mode = document.getElementById('lessonTimeType').value;
            const clock = document.getElementById('lessonTimeClock');
            if (mode === 'manual') {
                clock.classList.remove('hidden');
                clock.classList.add('block');
            } else {
                clock.classList.add('hidden');
                clock.classList.remove('block');
            }
        }

        function addLesson(e) {
            e.preventDefault();
            const locationSelect = document.getElementById('lessonLocationSelect');
            if (!locationSelect.value) { alert('חובה לבחור בית כנסת מהרשימה'); return; }

            let finalTime = "";
            const timeMode = document.getElementById('lessonTimeType').value;
            if (timeMode === 'manual') {
                const clockVal = document.getElementById('lessonTimeClock').value;
                if (!clockVal) { alert('אנא בחר שעה'); return; }
                finalTime = clockVal;
            } else {
                finalTime = timeMode;
            }

            const lessonObj = {
                id: editingLessonId ? editingLessonId : Date.now(),
                rabbi: document.getElementById('rabbiName').value,
                topic: document.getElementById('topic').value,
                title: document.getElementById('title').value,
                day: document.getElementById('day').value,
                time: finalTime,
                location: locationSelect.value
            };

            let items = getLessons();
            if (editingLessonId) {
                const index = items.findIndex(l => l.id === editingLessonId);
                if (index !== -1) items[index] = lessonObj;
                alert('השיעור עודכן בהצלחה!');
            } else {
                items.push(lessonObj);
                alert('השיעור נוסף בהצלחה!');
            }

            saveLessons(items);
            cancelEditLesson();
        }

        function deleteLesson(id) { if(confirm('למחוק?')) saveLessons(getLessons().filter(i => i.id !== id)); }
        
        function editLesson(id) {
            const lessons = getLessons();
            const lesson = lessons.find(l => l.id === id);
            if (!lesson) return;

            editingLessonId = id;
            document.getElementById('lessonLocationSelect').value = lesson.location;
            document.getElementById('rabbiName').value = lesson.rabbi;
            document.getElementById('topic').value = lesson.topic;
            document.getElementById('title').value = lesson.title;
            document.getElementById('day').value = lesson.day;

            const presetTimes = ["אחרי מנחה", "לפני מנחה", "אחרי ערבית", "לפני ערבית", "אחרי שחרית", "לפני שחרית"];
            if (presetTimes.includes(lesson.time)) {
                document.getElementById('lessonTimeType').value = lesson.time;
            } else {
                document.getElementById('lessonTimeType').value = 'manual';
                document.getElementById('lessonTimeClock').value = lesson.time;
            }
            toggleLessonTimeInput();

            document.getElementById('lessonFormTitle').innerText = 'עריכת שיעור';
            document.getElementById('saveLessonBtn').innerText = 'עדכן שיעור';
            document.getElementById('saveLessonBtn').classList.replace('bg-blue-600', 'bg-orange-600');
            document.getElementById('saveLessonBtn').classList.replace('hover:bg-blue-700', 'hover:bg-orange-700');
            document.getElementById('cancelLessonEditBtn').classList.remove('hidden');
            document.querySelector('#section-lessons').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditLesson() {
            editingLessonId = null;
            document.getElementById('addLessonForm').reset();
            document.getElementById('lessonTimeType').value = 'manual';
            toggleLessonTimeInput();
            document.getElementById('lessonFormTitle').innerText = 'הוספת שיעור';
            document.getElementById('saveLessonBtn').innerText = 'פרסם שיעור';
            document.getElementById('saveLessonBtn').classList.replace('bg-orange-600', 'bg-blue-600');
            document.getElementById('saveLessonBtn').classList.replace('hover:bg-orange-700', 'hover:bg-blue-700');
            document.getElementById('cancelLessonEditBtn').classList.add('hidden');
        }

        function loadLessonsTable() {
            const tbody = document.getElementById('lessonsTableBody');
            tbody.innerHTML = '';
            getLessons().forEach(item => {
                tbody.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold text-green-700">${item.location}</td>
                    <td class="p-3">
                        <div class="font-bold">${item.rabbi}</div>
                        <div class="text-xs text-gray-500">${item.title}</div>
                    </td>
                    <td class="p-3">${item.day}<br><span class="font-bold text-blue-600">${item.time}</span></td>
                    <td class="p-3 text-center">
                        <button onclick="editLesson(${item.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded ml-1"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteLesson(${item.id})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function updateLessonLocationOptions() {
            const select = document.getElementById('lessonLocationSelect');
            const shuls = getShuls();
            shuls.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            let html = '<option value="" disabled selected>בחר בית כנסת מהרשימה...</option>';
            shuls.forEach(s => { html += `<option value="${s.name}">${s.name}</option>`; });
            select.innerHTML = html;
        }

        function loadAllData() { loadLessonsTable(); loadShulTable(); updateLessonLocationOptions(); }
    </script>
</body>
</html>