<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××¢×¨×›×ª - ×’×‘××™ (××•× ×œ×™×™×Ÿ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .nav-btn { background-color: white; color: #4b5563; }
        .time-tag { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex items-center justify-center h-screen bg-blue-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <div class="mb-4 text-blue-600 text-5xl"><i class="fas fa-synagogue"></i></div>
            <h2 class="text-2xl font-bold mb-4">×›× ×™×¡×ª ×’×‘××™ / ×× ×”×œ</h2>
            <input type="text" id="username" placeholder="×©× ××©×ª××©" class="w-full mb-3 p-3 border rounded-lg bg-gray-50 text-lg">
            <input type="password" id="password" placeholder="×¡×™×¡××”" class="w-full mb-6 p-3 border rounded-lg bg-gray-50 text-lg">
            <button id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition transform active:scale-95">×”×›× ×¡ ×œ××¢×¨×›×ª</button>
            <p id="error-msg" class="text-red-500 text-sm mt-3 font-bold hidden"></p>
            <p id="loading-msg" class="text-blue-500 text-sm mt-3 hidden animate-pulse">××ª×—×‘×¨ ×œ×©×¨×ª...</p>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden min-h-screen pb-20">
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center text-blue-900 font-bold text-xl">
                <i class="fas fa-cloud ml-2"></i> <span id="navTitle">×¤×× ×œ × ×™×”×•×œ</span>
            </div>
            <button id="logoutBtn" class="text-red-500 text-sm hover:bg-red-50 px-3 py-1 rounded font-bold border border-red-100">×”×ª× ×ª×§</button>
        </nav>

        <div class="container mx-auto mt-6 px-4 flex justify-center gap-4" id="adminNavButtons">
            <button id="btn-prayers" class="nav-btn active px-6 py-2 rounded-full font-bold shadow-sm transition">
                <i class="fas fa-synagogue ml-2"></i> × ×™×”×•×œ ×‘×ª×™ ×›× ×¡×ª
            </button>
            <button id="btn-lessons" class="nav-btn px-6 py-2 rounded-full font-bold shadow-sm transition">
                <i class="fas fa-book-open ml-2"></i> × ×™×”×•×œ ×©×™×¢×•×¨×™×
            </button>
        </div>

        <div class="container mx-auto p-6">
            
            <div id="globalSettingsPanel" class="bg-indigo-50 border border-indigo-200 p-4 rounded-xl mb-6 hidden">
                <h3 class="text-lg font-bold text-indigo-900 mb-3"><i class="fas fa-clock ml-2"></i>×”×’×“×¨×•×ª ×–×× ×™× ×’×œ×•×‘×œ×™×•×ª (×“×§×•×ª)</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                    <div><label class="block font-bold mb-1">×›× ×™×¡×ª ×©×‘×ª (+)</label><input type="number" id="setting_entry" class="w-full p-2 border rounded text-center" value="11"></div>
                    <div><label class="block font-bold mb-1">×™×¦×™××ª ×©×‘×ª (+)</label><input type="number" id="setting_exit" class="w-full p-2 border rounded text-center" value="0"></div>
                    <div><label class="block font-bold mb-1">×¢×œ×•×ª ×”×©×—×¨ (+)</label><input type="number" id="setting_alot" class="w-full p-2 border rounded text-center" value="14"></div>
                    <div><label class="block font-bold mb-1">×˜×œ×™×ª/×ª×¤×™×œ×™×Ÿ (-)</label><input type="number" id="setting_talit" class="w-full p-2 border rounded text-center" value="-2"></div>
                    <div><label class="block font-bold mb-1">×¦××ª ×”×›×•×›×‘×™× (-)</label><input type="number" id="setting_tzeit" class="w-full p-2 border rounded text-center" value="-8"></div>
                </div>
                <button id="saveSettingsBtn" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 font-bold w-full md:w-auto">×©××•×¨ ×”×’×“×¨×•×ª ×–×× ×™×</button>
            </div>

            <div id="section-prayers" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1" id="editFormContainer">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-24 overflow-y-auto max-h-[90vh]">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-green-700" id="formTitle">×”×•×¡×¤×ª ×‘×™×ª ×›× ×¡×ª</h3>
                            <button id="cancelEditBtn" class="hidden text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded">×‘×™×˜×•×œ / ×—×“×©</button>
                        </div>
                        
                        <div id="authFields" class="bg-yellow-50 p-3 rounded border border-yellow-200 mb-4 hidden">
                            <h4 class="text-xs font-bold text-yellow-800 mb-2">ğŸ”‘ ×¤×¨×˜×™ ×’×™×©×” ×œ×’×‘××™</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="shulUser" placeholder="×©× ××©×ª××©" class="w-full p-2 border rounded text-sm">
                                <input type="text" id="shulPass" placeholder="×¡×™×¡××”" class="w-full p-2 border rounded text-sm">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs font-bold text-gray-500">×©× ×¨×©××™</label><input type="text" id="shulName" class="w-full p-2 border rounded" required></div>
                            <div><label class="text-xs font-bold text-gray-500">×›×™× ×•×™</label><input type="text" id="shulNickname" class="w-full p-2 border rounded"></div>
                        </div>

                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×›×ª×•×‘×ª</label><input type="text" id="shulAddress" class="w-full p-2 border rounded"></div>
                        
                        <div class="mb-3 bg-green-50 p-2 rounded border border-green-100">
                            <label class="text-xs font-bold text-green-700"><i class="fas fa-hand-holding-heart ml-1"></i> ×œ×™× ×§ ×œ×ª×¨×•××” (× ×“×¨×™× ×¤×œ×•×¡ / ×‘×™×˜ ×•×›×•')</label>
                            <input type="text" id="shulDonationLink" class="w-full p-2 border rounded text-sm text-left" placeholder="https://...">
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs font-bold text-gray-500">× ×•×¡×—</label><select id="shulNusach" class="w-full p-2 border rounded bg-slate-50"><option value="×¢×“×•×ª ×”××–×¨×—">×¢×“×•×ª ×”××–×¨×—</option><option value="×¡×¤×¨×“">×¡×¤×¨×“</option><option value="××©×›× ×–">××©×›× ×–</option><option value="×ª×™××Ÿ">×ª×™××Ÿ</option><option value="×—×‘×´×“">×—×‘×´×“</option><option value="××¨×•×§××™">××¨×•×§××™</option><option value="××—×™×“">××—×™×“</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">×¨×‘</label><input type="text" id="shulRabbi" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="mb-4"><label class="text-xs font-bold text-gray-500">×’×‘××™</label><input type="text" id="shulGabbai" class="w-full p-2 border rounded"></div>

                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 mb-4">
                            <label class="block text-xs font-bold text-blue-900 mb-2"><i class="fas fa-bullhorn ml-1"></i> ×œ×•×— ××•×“×¢×•×ª ×•×©××•×ª</label>
                            <div class="mb-2"><textarea id="shulMessage" rows="2" class="w-full p-2 border rounded text-sm" placeholder="×”×•×“×¢×” ×—×©×•×‘×”..."></textarea></div>
                            <div class="grid grid-cols-2 gap-2">
                                <textarea id="shulRefuah" rows="3" class="w-full p-2 border rounded text-sm" placeholder="×©××•×ª ×œ×¨×¤×•××”..."></textarea>
                                <textarea id="shulNishmat" rows="3" class="w-full p-2 border rounded text-sm" placeholder="×œ×¢×™×œ×•×™ × ×©××ª..."></textarea>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                            <label class="block text-xs font-bold text-gray-700 mb-2">ğŸ“… ×–×× ×™×</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select id="timeType" class="p-2 text-sm border rounded"><option value="shacharit">×©×—×¨×™×ª</option><option value="mincha">×× ×—×”</option><option value="arvit">×¢×¨×‘×™×ª</option></select>
                                <select id="timeDay" class="p-2 text-sm border rounded">
                                    <option value="chol">×™××™ ×—×•×œ (×¨×’×™×œ)</option>
                                    <option value="Sunday">×™×•× ×¨××©×•×Ÿ</option>
                                    <option value="Monday">×™×•× ×©× ×™</option>
                                    <option value="Tuesday">×™×•× ×©×œ×™×©×™</option>
                                    <option value="Wednesday">×™×•× ×¨×‘×™×¢×™</option>
                                    <option value="Thursday">×™×•× ×—××™×©×™</option>
                                    <option value="Friday">×™×•× ×©×™×©×™</option>
                                    <option value="Motzash">××•×¦"×©</option>
                                    <option disabled>â”€â”€</option>
                                    <option value="shabbat">×©×‘×ª</option>
                                    <option value="chag">×—×’</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <select id="timeMode" class="w-full p-2 text-sm border rounded bg-blue-50 text-blue-900 font-medium">
                                    <option value="manual">ğŸ•’ ×©×¢×” ××“×•×™×§×ª</option>
                                    <option value="before_sunset">â³ ×“×§×•×ª ×œ×¤× ×™ ×©×§×™×¢×”</option>
                                    <option value="before_exit_shabbat">â³ ×“×§×•×ª ×œ×¤× ×™ ×¦××ª ×©×‘×ª</option>
                                    <option value="sunset">ğŸŒ… ×©×§×™×¢×”</option>
                                    <option value="stars">âœ¨ ×¦××ª ×”×›×•×›×‘×™×</option>
                                    <option value="candles">ğŸ•¯ï¸ ×›× ×™×¡×ª ×©×‘×ª</option>
                                    <option value="sunrise">â˜€ï¸ ×”× ×¥ ×”×—××”</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <input type="time" id="timeClock" class="p-2 text-sm border rounded flex-grow">
                                <input type="number" id="minutesInput" placeholder="×“×§×•×ª" class="hidden p-2 text-sm border rounded w-20 flex-grow">
                                <button type="button" id="addTimeBtn" class="bg-green-600 text-white px-4 rounded hover:bg-green-700 font-bold"><i class="fas fa-plus"></i> ×”×•×¡×£</button>
                            </div>
                        </div>

                        <div id="timesListContainer" class="space-y-2 mb-4 text-sm">
                            <div id="list-shacharit" class="hidden border-r-2 border-yellow-400 pr-2"><span class="font-bold text-xs text-yellow-700 block">×©×—×¨×™×ª:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                            <div id="list-mincha" class="hidden border-r-2 border-orange-400 pr-2"><span class="font-bold text-xs text-orange-700 block">×× ×—×”:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                            <div id="list-arvit" class="hidden border-r-2 border-blue-400 pr-2"><span class="font-bold text-xs text-blue-700 block">×¢×¨×‘×™×ª:</span><div class="flex flex-wrap gap-1 mt-1 content"></div></div>
                        </div>

                        <button id="saveShulBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 shadow-md">×©××•×¨ ×‘×™×ª ×›× ×¡×ª</button>
                    </div>
                </div>
                
                <div class="lg:col-span-2" id="shulsListContainer">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full">
                        <h3 class="font-bold text-lg mb-4">×¨×©×™××ª ×‘×ª×™ ×”×›× ×¡×ª</h3>
                        <div class="overflow-x-auto"><table class="w-full text-right text-sm"><thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-3">×©×</th><th class="p-3">×’×‘××™ ××•×¨×©×”</th><th class="p-3 text-center">×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="shulTableBody"><tr><td colspan="3" class="p-4 text-center text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="section-lessons" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-24">
                        <h3 class="font-bold text-lg text-blue-800 mb-4" id="lessonFormTitle">×”×•×¡×¤×ª ×©×™×¢×•×¨</h3>
                        <div class="mb-3">
                            <label class="text-xs font-bold text-gray-500">×©×™×™×š ×œ×‘×™×ª ×›× ×¡×ª</label>
                            <select id="lessonLocationSelect" class="w-full p-2 border rounded bg-green-50 font-bold focus:ring-2 ring-green-200"><option value="" disabled selected>×˜×•×¢×Ÿ ×¨×©×™××”...</option></select>
                        </div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×¨×‘</label><input type="text" id="lessonRabbi" class="w-full p-2 border rounded"></div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">× ×•×©×</label><select id="lessonTopic" class="w-full p-2 border rounded"><option value="gemara">×’××¨× / ×“×£ ×™×•××™</option><option value="halacha">×”×œ×›×”</option><option value="parasha">×¤×¨×©×ª ×©×‘×•×¢</option><option value="mussar">××•×¡×¨</option></select></div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×›×•×ª×¨×ª</label><input type="text" id="lessonTitle" class="w-full p-2 border rounded"></div>
                        <div class="mb-3"><label class="text-xs font-bold text-gray-500">×™×•×</label><select id="lessonDay" class="w-full p-2 border rounded bg-blue-50"><option value="×›×œ ×™×•×">×›×œ ×™×•×</option><option value="×™×•× ×¨××©×•×Ÿ">×¨××©×•×Ÿ</option><option value="×™×•× ×©× ×™">×©× ×™</option><option value="×™×•× ×©×œ×™×©×™">×©×œ×™×©×™</option><option value="×™×•× ×¨×‘×™×¢×™">×¨×‘×™×¢×™</option><option value="×™×•× ×—××™×©×™">×—××™×©×™</option><option value="×™×•× ×©×™×©×™">×©×™×©×™</option><option value="××•×¦×´×©">××•×¦×´×©</option><option value="×©×‘×ª">×©×‘×ª</option></select></div>
                        <div class="mb-4">
                            <label class="text-xs font-bold text-gray-500">×–××Ÿ</label>
                            <div class="flex gap-2">
                                <select id="lessonTimeType" class="w-1/2 p-2 text-sm border rounded bg-slate-50"><option value="manual">ğŸ•’ ×©×¢×” ××“×•×™×§×ª</option><option value="××—×¨×™ ×× ×—×”">××—×¨×™ ×× ×—×”</option><option value="×œ×¤× ×™ ×× ×—×”">×œ×¤× ×™ ×× ×—×”</option><option value="××—×¨×™ ×¢×¨×‘×™×ª">××—×¨×™ ×¢×¨×‘×™×ª</option><option value="×œ×¤× ×™ ×¢×¨×‘×™×ª">×œ×¤× ×™ ×¢×¨×‘×™×ª</option><option value="××—×¨×™ ×©×—×¨×™×ª">××—×¨×™ ×©×—×¨×™×ª</option><option value="×œ×¤× ×™ ×©×—×¨×™×ª">×œ×¤× ×™ ×©×—×¨×™×ª</option></select>
                                <input type="time" id="lessonTimeClock" class="w-1/2 p-2 text-sm border rounded">
                            </div>
                        </div>
                        <button id="saveLessonBtn" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">×¤×¨×¡× ×©×™×¢×•×¨</button>
                        <button id="cancelLessonEditBtn" class="w-full mt-2 text-red-500 text-sm hidden">×‘×™×˜×•×œ</button>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full">
                        <h3 class="font-bold text-lg mb-4">×©×™×¢×•×¨×™× ×¤×¢×™×œ×™×</h3>
                        <div class="overflow-x-auto"><table class="w-full text-right text-sm"><thead class="bg-gray-50 text-gray-500 uppercase"><tr><th class="p-3">×‘×™×ª ×›× ×¡×ª</th><th class="p-3">×¨×‘ ×•×ª×•×›×Ÿ</th><th class="p-3">×–××Ÿ</th><th class="p-3">×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="lessonsTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, remove, get, onValue, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArvTHLvtHZwguLn0OpPMMJdqDKS7OnDOg",
            authDomain: "tirat-carmel-shul.firebaseapp.com",
            databaseURL: "https://tirat-carmel-shul-default-rtdb.firebaseio.com",
            projectId: "tirat-carmel-shul",
            storageBucket: "tirat-carmel-shul.firebasestorage.app",
            messagingSenderId: "645574971282",
            appId: "1:645574971282:web:9fb6720ea7c960ca37fb4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let tempTimes = { shacharit: [], mincha: [], arvit: [] };
        let editingShulId = null;
        let editingLessonId = null;
        let allShuls = [];
        let allLessons = {};
        let isSuperAdmin = false;
        let currentGabbaiShulId = null;
        let currentGabbaiShulName = null;

        document.getElementById('password').addEventListener('keyup', (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById('loginBtn').click();
            }
        });
        document.getElementById('username').addEventListener('keyup', (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById('password').focus();
            }
        });

        const settingsRef = ref(db, 'settings');
        onValue(settingsRef, (snapshot) => {
            const s = snapshot.val();
            if (s && isSuperAdmin) {
                document.getElementById('setting_entry').value = s.shabbatEntry || 11;
                document.getElementById('setting_exit').value = s.shabbatExit || 0;
                document.getElementById('setting_alot').value = s.alot || 14;
                document.getElementById('setting_talit').value = s.talit || -2;
                document.getElementById('setting_tzeit').value = s.tzeit || -8;
            }
        });

        document.getElementById('saveSettingsBtn').onclick = () => {
            const settings = {
                shabbatEntry: parseInt(document.getElementById('setting_entry').value),
                shabbatExit: parseInt(document.getElementById('setting_exit').value),
                alot: parseInt(document.getElementById('setting_alot').value),
                talit: parseInt(document.getElementById('setting_talit').value),
                tzeit: parseInt(document.getElementById('setting_tzeit').value)
            };
            set(ref(db, 'settings'), settings).then(() => alert('×”×’×“×¨×•×ª ×–×× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!'));
        };

        document.getElementById('loginBtn').onclick = async () => {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const errorMsg = document.getElementById('error-msg');
            const loadingMsg = document.getElementById('loading-msg');

            errorMsg.classList.add('hidden');
            errorMsg.innerText = "";
            loadingMsg.classList.remove('hidden');

            if (user === 'admin' && pass === '1234') {
                isSuperAdmin = true;
                loadingMsg.classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                document.getElementById('authFields').classList.remove('hidden'); 
                document.getElementById('globalSettingsPanel').classList.remove('hidden'); 
                document.getElementById('navTitle').innerText = "×× ×”×œ ××¢×¨×›×ª";
                renderShulTable();
                return;
            }

            try {
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, `users/${user}`));
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.password === pass) {
                        isSuperAdmin = false;
                        currentGabbaiShulId = userData.shulId;
                        
                        loadingMsg.classList.add('hidden');
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('dashboard-screen').classList.remove('hidden');
                        
                        document.getElementById('navTitle').innerText = `×©×œ×•×, ${user}`;
                        document.getElementById('shulsListContainer').classList.add('hidden'); 
                        document.getElementById('section-prayers').classList.replace('lg:grid-cols-3', 'grid-cols-1'); 
                        document.getElementById('editFormContainer').classList.replace('lg:col-span-1', 'lg:col-span-3'); 
                        document.getElementById('cancelEditBtn').classList.add('hidden'); 
                        document.getElementById('formTitle').innerText = "×¢×¨×™×›×ª ×¤×¨×˜×™ ×‘×™×ª ×”×›× ×¡×ª";

                        loadSingleShulForGabbai(currentGabbaiShulId);
                    } else {
                        throw new Error("×¡×™×¡××” ×©×’×•×™×”");
                    }
                } else {
                    throw new Error("××©×ª××© ×œ× × ××¦×");
                }
            } catch (error) {
                loadingMsg.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                errorMsg.innerText = error.message || "×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª";
            }
        };

        async function loadSingleShulForGabbai(shulId) {
            try {
                const snapshot = await get(child(ref(db), `prayers/${shulId}`));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentGabbaiShulName = data.name; 
                    loadShulForEdit(shulId, data);
                    document.getElementById('saveShulBtn').innerText = "×©××•×¨ ×©×™× ×•×™×™×";
                    updateLessonLocationOptions();
                    renderLessonTable();
                } else {
                    alert("×©×’×™××”: ×‘×™×ª ×”×›× ×¡×ª ×”××©×•×™×š ××œ×™×š ×œ× × ××¦× ×‘×××’×¨.");
                }
            } catch (e) {
                console.error("Error loading gabbai shul:", e);
                alert("×©×’×™××ª ×ª×§×©×•×¨×ª ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×");
            }
        }

        document.getElementById('logoutBtn').onclick = () => location.reload();

        document.getElementById('btn-prayers').onclick = () => switchSection('prayers');
        document.getElementById('btn-lessons').onclick = () => switchSection('lessons');

        function switchSection(section) {
            document.getElementById('section-lessons').classList.add('hidden');
            document.getElementById('section-prayers').classList.add('hidden');
            document.getElementById('btn-lessons').classList.remove('active');
            document.getElementById('btn-prayers').classList.remove('active');
            document.getElementById('section-' + section).classList.remove('hidden');
            document.getElementById('btn-' + section).classList.add('active');
        }

        document.getElementById('timeMode').onchange = () => {
            const mode = document.getElementById('timeMode').value;
            const clock = document.getElementById('timeClock');
            const mins = document.getElementById('minutesInput');
            clock.classList.add('hidden'); mins.classList.add('hidden');
            if (mode === 'manual') clock.classList.remove('hidden');
            else if (mode === 'before_sunset' || mode === 'before_exit_shabbat') mins.classList.remove('hidden');
        };

        document.getElementById('addTimeBtn').onclick = () => {
            const type = document.getElementById('timeType').value;
            const day = document.getElementById('timeDay').value;
            const mode = document.getElementById('timeMode').value;
            let timeValue = "";

            if (mode === 'manual') {
                if (!document.getElementById('timeClock').value) return alert('×‘×—×¨ ×©×¢×”');
                timeValue = document.getElementById('timeClock').value;
            } else if (mode === 'before_sunset') {
                if (!document.getElementById('minutesInput').value) return alert('×”×–×Ÿ ×“×§×•×ª');
                timeValue = `${document.getElementById('minutesInput').value} ×“×§' ×œ×¤× ×™ ×©×§×™×¢×”`;
            } else if (mode === 'before_exit_shabbat') {
                if (!document.getElementById('minutesInput').value) return alert('×”×–×Ÿ ×“×§×•×ª');
                timeValue = `${document.getElementById('minutesInput').value} ×“×§' ×œ×¤× ×™ ×¦××ª ×©×‘×ª`;
            } else {
                const map = { 'sunset': '×©×§×™×¢×”', 'stars': '×¦××ª ×”×›×•×›×‘×™×', 'sunrise': '×”× ×¥', 'candles': '×›× ×™×¡×ª ×©×‘×ª' };
                timeValue = map[mode];
            }
            tempTimes[type].push({ day: day, time: timeValue });
            renderTempTimes();
        };

        function renderTempTimes() {
            ['shacharit', 'mincha', 'arvit'].forEach(type => {
                const container = document.querySelector(`#list-${type} .content`);
                const parent = document.getElementById(`list-${type}`);
                container.innerHTML = '';
                if (tempTimes[type].length > 0) {
                    parent.classList.remove('hidden');
                    tempTimes[type].forEach((item, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'text-red-500 font-bold mr-2';
                        btn.innerHTML = 'Ã—';
                        btn.onclick = () => { tempTimes[type].splice(index, 1); renderTempTimes(); };
                        
                        const tag = document.createElement('div');
                        tag.className = 'time-tag bg-gray-100 border border-gray-300 rounded px-2 py-1 text-xs flex items-center mb-1';
                        const dayMap = { 'chol': '×—×•×œ', 'shabbat': '×©×‘×ª', 'chag': '×—×’', 'Sunday': '×\'', 'Monday': '×‘\'', 'Tuesday': '×’\'', 'Wednesday': '×“\'', 'Thursday': '×”\'', 'Friday': '×•\'', 'Motzash': '××•×¦"×©' };
                        tag.innerHTML = `<span>${dayMap[item.day] || item.day} <b>${item.time}</b></span>`;
                        tag.appendChild(btn);
                        container.appendChild(tag);
                    });
                } else { parent.classList.add('hidden'); }
            });
        }

        document.getElementById('saveShulBtn').onclick = () => {
            const name = document.getElementById('shulName').value;
            if (!name) return alert('×—×•×‘×” ×œ×”×–×™×Ÿ ×©×');

            const isShabbatOrChag = (day) => day === 'shabbat' || day === 'chag';
            const dayPriority = { 'chol': 0, 'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 'Thursday': 5, 'Friday': 6, 'Motzash': 7, 'shabbat': 8, 'chag': 9 };
            const dayMap = { 'chol': '×—×•×œ', 'shabbat': '×©×‘×ª', 'chag': '×—×’', 'Sunday': '×\'', 'Monday': '×‘\'', 'Tuesday': '×’\'', 'Wednesday': '×“\'', 'Thursday': '×”\'', 'Friday': '×•\'', 'Motzash': '××•×¦"×©' };

            const formatTimes = (list, isForShabbatCol) => {
                let filtered = list.filter(i => isForShabbatCol ? isShabbatOrChag(i.day) : !isShabbatOrChag(i.day));
                filtered.sort((a, b) => {
                    const rankA = dayPriority[a.day] !== undefined ? dayPriority[a.day] : 99;
                    const rankB = dayPriority[b.day] !== undefined ? dayPriority[b.day] : 99;
                    if (rankA !== rankB) return rankA - rankB;
                    return a.time.localeCompare(b.time);
                });
                return filtered.map(i => (i.day === 'chol' || i.day === 'shabbat') ? i.time : `${dayMap[i.day] || i.day} ${i.time}`).join(', ');
            };

            const shulData = {
                name: name,
                nickname: document.getElementById('shulNickname').value,
                address: document.getElementById('shulAddress').value,
                nusach: document.getElementById('shulNusach').value,
                rabbi: document.getElementById('shulRabbi').value,
                gabbai: document.getElementById('shulGabbai').value,
                shulUser: document.getElementById('shulUser').value,
                shulPass: document.getElementById('shulPass').value,
                message: document.getElementById('shulMessage').value,
                refuahNames: document.getElementById('shulRefuah').value,
                iluiNishmatNames: document.getElementById('shulNishmat').value,
                donationLink: document.getElementById('shulDonationLink').value, // ×©××™×¨×ª ×”×œ×™× ×§ ×œ×ª×¨×•××”
                shacharit_chol: formatTimes(tempTimes.shacharit, false),
                mincha_chol: formatTimes(tempTimes.mincha, false),
                arvit_chol: formatTimes(tempTimes.arvit, false),
                shacharit_shabbat: formatTimes(tempTimes.shacharit, true),
                mincha_shabbat: formatTimes(tempTimes.mincha, true),
                arvit_shabbat: formatTimes(tempTimes.arvit, true),
                rawTimes: tempTimes
            };

            let savePromise;
            let finalShulId = editingShulId;

            if (editingShulId) {
                savePromise = set(ref(db, 'prayers/' + editingShulId), shulData);
            } else {
                const newRef = push(ref(db, 'prayers'));
                finalShulId = newRef.key;
                savePromise = set(newRef, shulData);
            }

            savePromise.then(() => {
                const username = document.getElementById('shulUser').value.trim();
                const password = document.getElementById('shulPass').value.trim();

                if (username && password && isSuperAdmin) {
                    set(ref(db, 'users/' + username), {
                        password: password,
                        shulId: finalShulId
                    });
                }

                alert('× ×©××¨ ×‘×”×¦×œ×—×”!');
                if (isSuperAdmin) {
                    resetShulForm();
                } else {
                    console.log("Gabbai saved");
                }
            }).catch(error => {
                alert('×©×’×™××” ×‘×©××™×¨×”: ' + error.message);
                console.error(error);
            });
        };

        function resetShulForm() {
            editingShulId = null;
            document.getElementById('shulName').value = '';
            document.getElementById('shulNickname').value = '';
            document.getElementById('shulAddress').value = '';
            document.getElementById('shulRabbi').value = '';
            document.getElementById('shulGabbai').value = '';
            document.getElementById('shulUser').value = '';
            document.getElementById('shulPass').value = '';
            document.getElementById('shulMessage').value = '';
            document.getElementById('shulRefuah').value = '';
            document.getElementById('shulNishmat').value = '';
            document.getElementById('shulDonationLink').value = ''; // ××™×¤×•×¡ ×©×“×” ×ª×¨×•××”
            
            tempTimes = { shacharit: [], mincha: [], arvit: [] };
            renderTempTimes();
            document.getElementById('saveShulBtn').innerText = '×©××•×¨ ×‘×™×ª ×›× ×¡×ª';
            document.getElementById('saveShulBtn').classList.remove('bg-orange-600', 'hover:bg-orange-700');
            document.getElementById('saveShulBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('formTitle').innerText = '×”×•×¡×¤×ª ×‘×™×ª ×›× ×¡×ª';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        document.getElementById('cancelEditBtn').onclick = resetShulForm;

        window.duplicateShul = (item) => {
            if(!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×›×¤×œ ××ª "${item.name}"?`)) return;
            const newItem = JSON.parse(JSON.stringify(item));
            delete newItem.id;
            newItem.name = newItem.name + " (×¢×•×ª×§)";
            newItem.shulUser = ""; 
            newItem.shulPass = ""; 
            // ×©×›×¤×•×œ ×’× ×©×œ ×œ×™× ×§ ×”×ª×¨×•××”
            if(item.donationLink) newItem.donationLink = item.donationLink;

            push(ref(db, 'prayers'), newItem)
                .then(() => alert("×‘×™×ª ×”×›× ×¡×ª ×©×•×›×¤×œ ×‘×”×¦×œ×—×”!"))
                .catch(err => alert("×©×’×™××” ×‘×©×›×¤×•×œ: " + err.message));
        };

        onValue(ref(db, 'prayers'), (snapshot) => {
            const data = snapshot.val();
            allShuls = []; 
            if (data) {
                Object.entries(data).forEach(([id, item]) => allShuls.push({id, ...item}));
            }
            if (isSuperAdmin) renderShulTable();
            updateLessonLocationOptions(); 
        });

        function renderShulTable() {
            const tbody = document.getElementById('shulTableBody');
            if(!tbody) return;
            if (allShuls.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">×œ× × ××¦××• ×‘×ª×™ ×›× ×¡×ª.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            allShuls.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-3 font-bold">${item.name}</td>
                    <td class="p-3 text-xs">
                       ${item.shulUser ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-mono">${item.shulUser}</span>` : '<span class="text-gray-400">-</span>'}
                    </td>
                    <td class="p-3 text-center flex justify-center">
                        <button class="copy-btn text-orange-500 hover:bg-orange-50 p-2 rounded ml-1" title="×©×›×¤×œ"><i class="fas fa-copy"></i></button>
                        <button class="edit-btn text-blue-500 hover:bg-blue-50 p-2 rounded ml-1"><i class="fas fa-pen"></i></button>
                        <button class="del-btn text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tr.querySelector('.del-btn').onclick = () => { if(confirm('×œ××—×•×§?')) remove(ref(db, 'prayers/' + item.id)); };
                tr.querySelector('.edit-btn').onclick = () => loadShulForEdit(item.id, item);
                tr.querySelector('.copy-btn').onclick = () => window.duplicateShul(item);
                tbody.appendChild(tr);
            });
        }

        function loadShulForEdit(id, item) {
            editingShulId = id;
            document.getElementById('shulName').value = item.name;
            document.getElementById('shulNickname').value = item.nickname || '';
            document.getElementById('shulAddress').value = item.address || '';
            document.getElementById('shulNusach').value = item.nusach;
            document.getElementById('shulRabbi').value = item.rabbi || '';
            document.getElementById('shulGabbai').value = item.gabbai || '';
            document.getElementById('shulUser').value = item.shulUser || '';
            document.getElementById('shulPass').value = item.shulPass || '';
            
            document.getElementById('shulMessage').value = item.message || '';
            document.getElementById('shulRefuah').value = item.refuahNames || '';
            document.getElementById('shulNishmat').value = item.iluiNishmatNames || '';
            document.getElementById('shulDonationLink').value = item.donationLink || ''; // ×˜×¢×™× ×ª ×œ×™× ×§ ×œ×ª×¨×•××”
            
            // --- ×ª×™×§×•×Ÿ ×œ×˜×¢×™× ×ª × ×ª×•× ×™× ×™×©× ×™× ---
            let raw = item.rawTimes;
            let newStructure = { shacharit: [], mincha: [], arvit: [] };

            if (!raw) {
                tempTimes = newStructure;
            } else if (Array.isArray(raw)) {
                raw.forEach(t => {
                    let typeKey = t.type; 
                    if (typeKey === 'shacarit') typeKey = 'shacharit'; 
                    if (newStructure[typeKey]) {
                        newStructure[typeKey].push({ day: t.day, time: t.val || t.time });
                    }
                });
                tempTimes = newStructure;
            } else {
                if (!raw.shacharit) raw.shacharit = [];
                if (!raw.mincha) raw.mincha = [];
                if (!raw.arvit) raw.arvit = [];
                tempTimes = raw;
            }

            renderTempTimes();

            document.getElementById('saveShulBtn').innerText = '×¢×“×›×Ÿ ×‘×™×ª ×›× ×¡×ª';
            document.getElementById('saveShulBtn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('saveShulBtn').classList.add('bg-orange-600', 'hover:bg-orange-700');
            document.getElementById('formTitle').innerText = '×¢×¨×™×›×ª ×‘×™×ª ×›× ×¡×ª';
            
            if(isSuperAdmin) {
                document.getElementById('cancelEditBtn').classList.remove('hidden');
                document.querySelector('#section-prayers').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function updateLessonLocationOptions() {
            const select = document.getElementById('lessonLocationSelect');
            if(!select) return;
            select.innerHTML = '<option value="" disabled selected>×‘×—×¨ ×‘×™×ª ×›× ×¡×ª...</option>';
            
            if (!isSuperAdmin && currentGabbaiShulName) {
                select.innerHTML = `<option value="${currentGabbaiShulName}">${currentGabbaiShulName}</option>`;
                select.disabled = true; 
                return;
            }

            allShuls.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            allShuls.forEach(s => {
                select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
            });
        }

        document.getElementById('lessonTimeType').onchange = () => {
            const mode = document.getElementById('lessonTimeType').value;
            const clock = document.getElementById('lessonTimeClock');
            if (mode === 'manual') {
                clock.classList.remove('hidden');
                clock.classList.add('block');
            } else {
                clock.classList.add('hidden');
                clock.classList.remove('block');
            }
        };

        document.getElementById('saveLessonBtn').onclick = (e) => {
            e.preventDefault();
            let location = document.getElementById('lessonLocationSelect').value;
            if (!isSuperAdmin && currentGabbaiShulName) {
                location = currentGabbaiShulName;
            }
            
            if (!location) return alert('×‘×—×¨ ×‘×™×ª ×›× ×¡×ª');

            let finalTime = "";
            const mode = document.getElementById('lessonTimeType').value;
            if (mode === 'manual') {
                if (!document.getElementById('lessonTimeClock').value) return alert('×‘×—×¨ ×©×¢×”');
                finalTime = document.getElementById('lessonTimeClock').value;
            } else {
                finalTime = mode;
            }

            const lessonData = {
                location: location,
                rabbi: document.getElementById('lessonRabbi').value,
                topic: document.getElementById('lessonTopic').value,
                title: document.getElementById('lessonTitle').value,
                day: document.getElementById('lessonDay').value,
                time: finalTime
            };

            if (editingLessonId) {
                set(ref(db, 'lessons/' + editingLessonId), lessonData);
                alert('×¢×•×“×›×Ÿ');
            } else {
                push(ref(db, 'lessons'), lessonData);
                alert('× ×•×¡×£');
            }
            resetLessonForm();
        };

        function resetLessonForm() {
            editingLessonId = null;
            
            if (isSuperAdmin) {
                document.getElementById('lessonLocationSelect').value = "";
                document.getElementById('lessonLocationSelect').disabled = false;
            }
            
            document.getElementById('lessonRabbi').value = "";
            document.getElementById('lessonTopic').value = "gemara";
            document.getElementById('lessonTitle').value = "";
            
            document.getElementById('lessonTimeType').value = 'manual';
            document.getElementById('lessonTimeClock').classList.remove('hidden');
            
            document.getElementById('lessonFormTitle').innerText = '×”×•×¡×¤×ª ×©×™×¢×•×¨';
            document.getElementById('saveLessonBtn').innerText = '×¤×¨×¡× ×©×™×¢×•×¨';
            document.getElementById('saveLessonBtn').classList.remove('bg-orange-600', 'hover:bg-orange-700');
            document.getElementById('saveLessonBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('cancelLessonEditBtn').classList.add('hidden');
        }
        document.getElementById('cancelLessonEditBtn').onclick = resetLessonForm;

        onValue(ref(db, 'lessons'), (snapshot) => {
            allLessons = snapshot.val() || {};
            renderLessonTable();
        });

        function renderLessonTable() {
            const tbody = document.getElementById('lessonsTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            if (allLessons) {
                Object.entries(allLessons).forEach(([id, item]) => {
                    if (!isSuperAdmin && currentGabbaiShulName && item.location !== currentGabbaiShulName) {
                        return;
                    }

                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-3 font-bold text-green-700">${item.location}</td>
                        <td class="p-3">
                            <div class="font-bold">${item.rabbi}</div>
                            <div class="text-xs text-gray-500">${item.title}</div>
                        </td>
                        <td class="p-3 text-sm">${item.day}<br><span class="font-bold text-blue-600">${item.time}</span></td>
                        <td class="p-3 text-center">
                            <button class="edit-l-btn text-blue-500 hover:bg-blue-50 p-2 rounded ml-1"><i class="fas fa-pen"></i></button>
                            <button class="del-l-btn text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tr.querySelector('.del-l-btn').onclick = () => { if(confirm('×œ××—×•×§?')) remove(ref(db, 'lessons/' + id)); };
                    tr.querySelector('.edit-l-btn').onclick = () => loadLessonForEdit(id, item);
                    tbody.appendChild(tr);
                });
            }
        }

        function loadLessonForEdit(id, item) {
            editingLessonId = id;
            document.getElementById('lessonLocationSelect').value = item.location;
            document.getElementById('lessonRabbi').value = item.rabbi;
            document.getElementById('lessonTopic').value = item.topic;
            document.getElementById('lessonTitle').value = item.title;
            document.getElementById('lessonDay').value = item.day;

            const presetTimes = ["××—×¨×™ ×× ×—×”", "×œ×¤× ×™ ×× ×—×”", "××—×¨×™ ×¢×¨×‘×™×ª", "×œ×¤× ×™ ×¢×¨×‘×™×ª", "××—×¨×™ ×©×—×¨×™×ª", "×œ×¤× ×™ ×©×—×¨×™×ª"];
            if (presetTimes.includes(item.time)) {
                document.getElementById('lessonTimeType').value = item.time;
                document.getElementById('lessonTimeClock').classList.add('hidden');
            } else {
                document.getElementById('lessonTimeType').value = 'manual';
                document.getElementById('lessonTimeClock').value = item.time;
                document.getElementById('lessonTimeClock').classList.remove('hidden');
            }

            document.getElementById('lessonFormTitle').innerText = '×¢×¨×™×›×ª ×©×™×¢×•×¨';
            document.getElementById('saveLessonBtn').innerText = '×¢×“×›×Ÿ ×©×™×¢×•×¨';
            document.getElementById('saveLessonBtn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('saveLessonBtn').classList.add('bg-orange-600', 'hover:bg-orange-700');
            document.getElementById('cancelLessonEditBtn').classList.remove('hidden');
            document.querySelector('#section-lessons').scrollIntoView({ behavior: 'smooth' });
        }

    </script>
</body>
</html>
### 2. ×§×•×‘×¥ ×”×‘×™×ª (`index.html`)
**×”×©×™× ×•×™×™× ×©×‘×•×¦×¢×•:**
* ×‘×¢×ª ×œ×—×™×¦×” ×¢×œ ×›×¨×˜×™×¡ ×‘×™×ª ×›× ×¡×ª, ×”×§×•×“ ×‘×•×“×§ ×× ×§×™×™× `donationLink` ×œ×‘×™×ª ×”×›× ×¡×ª ×”×–×”.
* ×× ×§×™×™× ×§×™×©×•×¨, × ×•×¡×£ ×›×¤×ª×•×¨ ×¦×”×•×‘ ×‘×•×œ×˜ "×ª×¨×•××” ×œ×‘×™×ª ×”×›× ×¡×ª" ×‘×—×œ×§ ×”×ª×—×ª×•×Ÿ ×©×œ ×”×¤×•×¤-××¤.

```html
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×ª×™ ×›× ×¡×ª ×‘×˜×™×¨×ª ×”×›×¨××œ - ×”×œ×•×— ×”×“×™×’×™×˜×œ×™</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700;900&display=swap](https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700;900&display=swap)" rel="stylesheet">
    <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css)">
    
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.15); }
        .fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .digital-clock { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
        
        /* Minyan Alert Animations */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); border-color: #ef4444; }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); border-color: #ef4444; }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: #ef4444; }
        }
        .minyan-alert { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        
        /* Filter Buttons */
        .filter-btn.active { background-color: #1e3a8a; color: white; border-color: #1e3a8a; }
        .filter-btn { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="text-slate-800 bg-slate-100">

    <header class="bg-gradient-to-b from-blue-900 to-blue-800 text-white shadow-xl pb-8 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <i class="fas fa-star-of-david absolute top-10 left-10 text-9xl"></i>
            <i class="fas fa-synagogue absolute bottom-10 right-10 text-9xl"></i>
        </div>

        <div class="container mx-auto px-4 py-3 flex justify-between items-center border-b border-blue-700/50 text-sm md:text-base relative z-10">
            <div class="flex items-center gap-2">
                <i class="far fa-calendar-alt text-blue-300"></i>
                <span id="hebrew-date" class="font-bold text-lg text-yellow-300">×˜×•×¢×Ÿ ×ª××¨×™×š...</span>
                <span class="opacity-50 mx-1">|</span>
                <span id="gregorian-date" class="text-blue-200"></span>
            </div>
            <div class="bg-blue-950/80 px-4 py-1 rounded-full border border-blue-600 shadow-lg">
                <span id="parasha" class="font-bold text-orange-300 tracking-wide">×˜×•×¢×Ÿ...</span>
            </div>
        </div>

        <div class="container mx-auto px-4 mt-6 relative z-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-8">
                <div class="text-center md:text-right">
                    <h1 class="text-2xl md:text-4xl font-black tracking-tight mb-2 text-white">×‘×ª×™ ×›× ×¡×ª ×‘×˜×™×¨×ª ×”×›×¨××œ</h1>
                    <div class="text-5xl md:text-6xl font-black text-blue-100 digital-clock tracking-widest drop-shadow-lg" id="real-time-clock">--:--:--</div>
                </div>

                <div class="flex gap-4">
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-2xl text-center min-w-[130px] shadow-lg">
                        <div class="text-xs text-blue-200 mb-1 font-bold">×›× ×™×¡×ª ×©×‘×ª</div>
                        <div id="shabbat-entry" class="text-3xl font-bold text-white tracking-tight">--:--</div>
                        <div class="mt-1 text-orange-400"><i class="fas fa-candles"></i></div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-2xl text-center min-w-[130px] shadow-lg">
                        <div class="text-xs text-blue-200 mb-1 font-bold">×¦××ª ×©×‘×ª</div>
                        <div id="shabbat-exit" class="text-3xl font-bold text-white tracking-tight">--:--</div>
                        <div id="rt-exit" class="text-xs text-blue-200 font-bold mt-1 bg-blue-900/50 rounded px-1">×¨"×ª: --:--</div>
                        <div class="mt-1 text-purple-300"><i class="fas fa-star"></i></div>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-blue-950/60 rounded-xl p-3 border border-blue-600/50 overflow-x-auto scrollbar-hide shadow-inner">
                <div class="flex justify-between items-center min-w-[600px] gap-6 px-2" id="zmanim-bar">
                    <span class="text-white/50 text-sm animate-pulse">×˜×•×¢×Ÿ × ×ª×•× ×™×...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 min-h-[500px] -mt-4 relative z-20">
        <div class="bg-white p-4 rounded-xl shadow-md mb-6 max-w-2xl mx-auto">
            <div class="flex items-center bg-slate-100 p-1 rounded-full mb-4 relative shadow-inner">
                <i class="fas fa-search text-slate-400 mr-4 text-lg"></i>
                <input type="text" id="searchShul" placeholder="×—×¤×© ×‘×™×ª ×›× ×¡×ª, ×©× ×©×œ ×¨×‘, ××• × ×•×©×..." class="w-full bg-transparent outline-none font-bold text-lg py-3 pl-20 text-slate-700">
                <button id="manualSearchBtn" class="absolute left-1 top-1 bottom-1 bg-blue-600 text-white px-6 rounded-full font-bold hover:bg-blue-700 transition shadow-md flex items-center gap-2">
                    ×—×¤×© <i class="fas fa-arrow-left text-xs"></i>
                </button>
            </div>
            
            <div class="flex justify-center gap-3">
                <button onclick="setFilter('all')" id="btn-all" class="filter-btn active px-4 py-1 rounded-full font-bold text-sm transition-all shadow-sm">×”×›×œ</button>
                <button onclick="setFilter('minyan')" id="btn-minyan" class="filter-btn px-4 py-1 rounded-full font-bold text-sm transition-all shadow-sm flex items-center gap-2"><i class="fas fa-clock"></i> ×× ×™×™×Ÿ ×§×¨×•×‘ â±ï¸</button>
            </div>
        </div>

        <div id="prayers-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-20 text-slate-500 bg-white rounded-2xl shadow">
                <i class="fas fa-cloud-download-alt text-4xl mb-4 text-blue-300 animate-bounce"></i>
                <p>××ª×—×‘×¨ ×œ× ×ª×•× ×™× ×‘×–××Ÿ ×××ª...</p>
            </div>
        </div>
    </main>

    <div id="shulModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-right px-6">
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <p class="text-2xl font-bold text-blue-900" id="modalTitle">×©× ×‘×™×ª ×”×›× ×¡×ª</p>
                    <div class="modal-close cursor-pointer z-50 text-gray-500 hover:text-red-500">
                        <i class="fas fa-times text-2xl"></i>
                    </div>
                </div>

                <div class="mt-4 flex justify-center">
                    <button id="btnMinyanSOS" class="bg-red-100 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white transition rounded-full px-6 py-2 font-bold flex items-center gap-2 text-sm">
                        <i class="fas fa-bell"></i> ×—×¡×¨ ×œ× ×• ×× ×™×™×Ÿ! ×œ×—×¥ ×›××Ÿ ğŸ†˜
                    </button>
                </div>

                <div id="modalBody" class="mt-4 space-y-4">
                    </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end gap-2" id="modalFooterBtns">
                    </div>
            </div>
        </div>
    </div>

    <a href="admin.html" class="fixed bottom-6 left-6 bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl hover:bg-slate-700 transition z-50 flex items-center gap-3 font-bold border border-slate-600 opacity-90 hover:opacity-100">
        <i class="fas fa-user-cog text-xl"></i>
        <span>× ×™×”×•×œ ×’×‘××™</span>
    </a>

    <a href="[https://kosher-e90e3.web.app/](https://kosher-e90e3.web.app/)" target="_blank" class="fixed bottom-6 right-6 bg-red-600 text-white px-5 py-3 rounded-full shadow-2xl hover:bg-red-700 transition z-50 flex items-center gap-3 font-bold border border-red-500 opacity-90 hover:opacity-100">
        <i class="fab fa-youtube text-xl"></i>
        <span>×™×•×˜×™×•×‘ ×›×©×¨</span>
    </a>

    <script type="module">
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js](https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js)";
        import { getDatabase, ref, onValue, set } from "[https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js](https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js)";

        const firebaseConfig = {
            apiKey: "AIzaSyArvTHLvtHZwguLn0OpPMMJdqDKS7OnDOg",
            authDomain: "tirat-carmel-shul.firebaseapp.com",
            databaseURL: "[https://tirat-carmel-shul-default-rtdb.firebaseio.com](https://tirat-carmel-shul-default-rtdb.firebaseio.com)",
            projectId: "tirat-carmel-shul",
            storageBucket: "tirat-carmel-shul.firebasestorage.app",
            messagingSenderId: "645574971282",
            appId: "1:645574971282:web:9fb6720ea7c960ca37fb4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let liveShuls = [];
        let liveLessons = [];
        let globalSettings = {};
        let minyanAlerts = {};
        let dailyTimes = {}; 
        let currentFilter = 'all';

        function updateClock() {
            const now = new Date();
            document.getElementById('real-time-clock').innerText = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }
        setInterval(updateClock, 1000);
        updateClock();

        onValue(ref(db, 'settings'), (snapshot) => {
            globalSettings = snapshot.val() || { shabbatEntry: 11, shabbatExit: 0, alot: 14, talit: -2, tzeit: -8 };
            fetchHebcalData();
        });

        onValue(ref(db, 'prayers'), (snapshot) => {
            const data = snapshot.val();
            liveShuls = data ? Object.entries(data).map(([k, v]) => ({ id: k, ...v })) : [];
            renderData();
        });

        onValue(ref(db, 'lessons'), (snapshot) => {
            const data = snapshot.val();
            liveLessons = data ? Object.values(data) : [];
            renderData();
        });

        onValue(ref(db, 'minyanAlerts'), (snapshot) => {
            minyanAlerts = snapshot.val() || {};
            renderData();
        });

        window.setFilter = (type) => {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(type === 'all' ? 'btn-all' : 'btn-minyan').classList.add('active');
            renderData();
        }

        function getAdjustedTime(isoDateString, minutesToAdd) {
            if (!isoDateString) return "--:--";
            const date = new Date(isoDateString);
            date.setMinutes(date.getMinutes() + minutesToAdd);
            return date.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', hour12: false});
        }

        function parseDynamicTime(rawText) {
            if (!rawText || !dailyTimes.sunset) return rawText;
            let timeStr = rawText;

            if (rawText.includes("×œ×¤× ×™ ×©×§×™×¢×”")) {
                const mins = parseInt(rawText.match(/(\d+)\s*×“×§/)?.[1] || 0);
                timeStr = timeStr.replace(/\d+\s*×“×§'\s*×œ×¤× ×™\s*×©×§×™×¢×”/, getAdjustedTime(dailyTimes.sunset, -mins));
            } else if (rawText.includes("×œ×¤× ×™ ×¦××ª ×©×‘×ª")) {
                const mins = parseInt(rawText.match(/(\d+)\s*×“×§/)?.[1] || 0);
                timeStr = timeStr.replace(/\d+\s*×“×§'\s*×œ×¤× ×™\s*×¦××ª\s*×©×‘×ª/, getAdjustedTime(dailyTimes.exit, -mins));
            } else if (rawText.includes("×¦××ª ×”×›×•×›×‘×™×")) {
                timeStr = timeStr.replace("×¦××ª ×”×›×•×›×‘×™×", dailyTimes.tzeit);
            } else if (rawText.includes("×©×§×™×¢×”")) {
                timeStr = timeStr.replace("×©×§×™×¢×”", getAdjustedTime(dailyTimes.sunset, 0));
            } else if (rawText.includes("×›× ×™×¡×ª ×©×‘×ª")) {
                timeStr = timeStr.replace("×›× ×™×¡×ª ×©×‘×ª", dailyTimes.candles);
            } else if (rawText.includes("×”× ×¥")) {
                timeStr = timeStr.replace("×”× ×¥", dailyTimes.sunrise);
            }
            return timeStr;
        }

        function timeToMinutes(timeStr) {
            if(!timeStr || !timeStr.includes(':')) return -1;
            const match = timeStr.match(/\d{2}:\d{2}/);
            if(!match) return -1;
            const [h, m] = match[0].split(':').map(Number);
            return h * 60 + m;
        }

        const formatList = (str) => {
            if (!str) return '-';
            return str.split(', ').map(timeStr => parseDynamicTime(timeStr)).join('<br>');
        };

        const modal = document.getElementById('shulModal');
        const closeModal = document.querySelectorAll('.modal-close, .modal-overlay');

        function toggleModal() {
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }

        closeModal.forEach(el => el.addEventListener('click', toggleModal));

        window.triggerMinyanAlert = (shulId) => {
            if (confirm("×”×× ×œ×”×¤×¢×™×œ ×”×ª×¨××ª ×—×¡×¨ ×× ×™×™×Ÿ ×œ-10 ×“×§×•×ª?")) {
                const alertRef = ref(db, `minyanAlerts/${shulId}`);
                set(alertRef, Date.now());
                alert("×”×”×ª×¨××” ×”×•×¤×¢×œ×” ×•×ª×•×¤×™×¢ ×‘×“×£ ×”×¨××©×™.");
                toggleModal();
            }
        };

        window.openShulModal = (shulId) => {
            const shul = liveShuls.find(s => s.id === shulId);
            if (!shul) return;

            document.getElementById('modalTitle').innerText = shul.name;
            if(shul.nickname) document.getElementById('modalTitle').innerText += ` (${shul.nickname})`;
            
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(shul.address || shul.name + " ×˜×™×¨×ª ×”×›×¨××œ")}`;
            
            const sosBtn = document.getElementById('btnMinyanSOS');
            sosBtn.onclick = () => triggerMinyanAlert(shul.id);

            const shulLessons = liveLessons.filter(l => l.location === shul.name);
            let lessonsHtml = '';
            if (shulLessons.length > 0) {
                lessonsHtml = `<div class="bg-orange-50 p-4 rounded-lg mt-4 border border-orange-100"><h4 class="font-bold text-orange-800 mb-2">×©×™×¢×•×¨×™ ×ª×•×¨×”</h4>`;
                shulLessons.forEach(l => {
                    let rabbiName = l.rabbi.trim();
                    if (!rabbiName.startsWith('×”×¨×‘')) rabbiName = '×”×¨×‘ ' + rabbiName;
                    lessonsHtml += `
                        <div class="flex justify-between items-start text-sm bg-white p-2 mb-2 rounded border border-orange-200">
                            <div><span class="font-bold">${rabbiName}</span> - ${l.title}</div>
                            <div class="text-left"><span class="bg-orange-100 px-1 rounded">${l.day}</span> ${l.time}</div>
                        </div>`;
                });
                lessonsHtml += `</div>`;
            }

            let messagesHtml = '';
            if (shul.message || shul.refuahNames || shul.iluiNishmatNames) {
                messagesHtml = `<div class="mt-6 space-y-3">`;
                if (shul.message) messagesHtml += `<div class="bg-blue-100 p-3 rounded-lg border border-blue-200"><h5 class="font-bold text-blue-900 mb-1 text-sm"><i class="fas fa-bullhorn ml-1"></i> ×”×•×“×¢×” ×—×©×•×‘×”:</h5><p class="text-sm whitespace-pre-wrap">${shul.message}</p></div>`;
                if (shul.refuahNames) messagesHtml += `<div class="bg-green-50 p-3 rounded-lg border border-green-200"><h5 class="font-bold text-green-900 mb-1 text-sm"><i class="fas fa-heartbeat ml-1"></i> ×œ×¨×¤×•××” ×©×œ××”:</h5><p class="text-sm whitespace-pre-wrap">${shul.refuahNames}</p></div>`;
                if (shul.iluiNishmatNames) messagesHtml += `<div class="bg-gray-100 p-3 rounded-lg border border-gray-300"><h5 class="font-bold text-gray-800 mb-1 text-sm"><i class="fas fa-candle-holder ml-1"></i> ×œ×¢×™×œ×•×™ × ×©××ª:</h5><p class="text-sm whitespace-pre-wrap">${shul.iluiNishmatNames}</p></div>`;
                messagesHtml += `</div>`;
            }

            const detailsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="text-sm text-gray-500 mb-1"><i class="fas fa-map-marker-alt ml-2"></i>×›×ª×•×‘×ª</div>
                        <div class="font-bold text-lg mb-3">${shul.address || '×œ× ×¦×•×™× ×”'}</div>
                        <div class="text-sm text-gray-500 mb-1"><i class="fas fa-book ml-2"></i>× ×•×¡×—</div>
                        <div class="font-bold text-lg mb-3">${shul.nusach || '×œ× ×¦×•×™×Ÿ'}</div>
                        ${shul.rabbi ? `<div class="text-sm text-gray-500 mb-1">×¨×‘</div><div class="font-bold text-lg mb-3">${shul.rabbi}</div>` : ''}
                        ${shul.gabbai ? `<div class="text-sm text-gray-500 mb-1">×’×‘××™</div><div class="font-bold text-lg mb-3">${shul.gabbai}</div>` : ''}
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-bold text-blue-900 border-b border-gray-200 pb-2 mb-2">×–×× ×™ ×ª×¤×™×œ×” (××—×•×©×‘ ×œ×”×™×•×)</h4>
                        <div class="space-y-3 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="block font-bold text-gray-500">×—×•×œ - ×©×—×¨×™×ª</span><span>${formatList(shul.shacharit_chol)}</span></div>
                                <div><span class="block font-bold text-blue-500">×©×‘×ª - ×©×—×¨×™×ª</span><span>${formatList(shul.shacharit_shabbat)}</span></div>
                                <div><span class="block font-bold text-gray-500">×—×•×œ - ×× ×—×”</span><span>${formatList(shul.mincha_chol)}</span></div>
                                <div><span class="block font-bold text-blue-500">×©×‘×ª - ×× ×—×”</span><span>${formatList(shul.mincha_shabbat)}</span></div>
                                <div><span class="block font-bold text-gray-500">×—×•×œ - ×¢×¨×‘×™×ª</span><span>${formatList(shul.arvit_chol)}</span></div>
                                <div><span class="block font-bold text-blue-500">×©×‘×ª - ×¢×¨×‘×™×ª</span><span>${formatList(shul.arvit_shabbat)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                ${lessonsHtml}
                ${messagesHtml}
            `;

            document.getElementById('modalBody').innerHTML = detailsHtml;

            // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™× ×‘×¤×•×˜×¨ (×ª×¨×•××” + × ×™×•×•×˜)
            let btnsHtml = `
                <a href="${mapUrl}" target="_blank" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                    <i class="fas fa-location-arrow"></i> × ×•×•×˜ ×œ××§×•×
                </a>
            `;
            
            if (shul.donationLink) {
                btnsHtml = `
                    <a href="${shul.donationLink}" target="_blank" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 font-bold flex items-center gap-2 shadow-md">
                        <i class="fas fa-hand-holding-heart"></i> ×ª×¨×•××” ×œ×‘×™×ª ×”×›× ×¡×ª
                    </a>
                    ` + btnsHtml;
            }

            document.getElementById('modalFooterBtns').innerHTML = btnsHtml;
            toggleModal();
        };

        function renderData() {
            const container = document.getElementById('prayers-grid');
            const search = document.getElementById('searchShul').value.toLowerCase();
            
            let filteredShuls = liveShuls.filter(s => {
                const inName = s.name.toLowerCase().includes(search);
                const inAddress = (s.address || "").toLowerCase().includes(search);
                const inNusach = (s.nusach || "").toLowerCase().includes(search);
                
                let inLessons = false;
                if (liveLessons) {
                    const shulLessons = liveLessons.filter(l => l.location === s.name);
                    inLessons = shulLessons.some(l => 
                        (l.rabbi && l.rabbi.toLowerCase().includes(search)) || 
                        (l.topic && l.topic.toLowerCase().includes(search))
                    );
                }
                
                return inName || inAddress || inNusach || inLessons;
            });

            if (currentFilter === 'minyan') {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                
                filteredShuls = filteredShuls.map(s => {
                    let nextPrayer = null;
                    let minDiff = Infinity;
                    
                    const timesToCheck = [
                        { type: '×©×—×¨×™×ª', val: s.shacharit_chol },
                        { type: '×× ×—×”', val: s.mincha_chol },
                        { type: '×¢×¨×‘×™×ª', val: s.arvit_chol }
                    ];

                    timesToCheck.forEach(t => {
                        if(!t.val) return;
                        const times = t.val.split(', ');
                        times.forEach(rawTime => {
                            const parsed = parseDynamicTime(rawTime);
                            const tMins = timeToMinutes(parsed);
                            
                            if (tMins > currentMinutes) {
                                const diff = tMins - currentMinutes;
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    nextPrayer = { type: t.type, time: parsed, rawDiff: diff };
                                }
                            }
                        });
                    });

                    return { ...s, nextPrayer };
                })
                .filter(s => s.nextPrayer) 
                .sort((a, b) => a.nextPrayer.rawDiff - b.nextPrayer.rawDiff);
            } else {
                filteredShuls.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            }

            if (filteredShuls.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-slate-500 bg-white rounded-2xl shadow"><p>×œ× × ××¦××• ×ª×•×¦××•×ª.</p></div>`;
                return;
            }

            container.innerHTML = '';
            const now = Date.now();
            
            filteredShuls.forEach(shul => {
                let isAlertActive = false;
                if (minyanAlerts[shul.id]) {
                    const diff = now - minyanAlerts[shul.id];
                    if (diff < 10 * 60 * 1000) isAlertActive = true;
                }

                const alertClass = isAlertActive ? 'minyan-alert bg-red-50' : 'bg-white border-slate-100';
                const alertBadge = isAlertActive ? `<div class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg animate-pulse z-20">×—×¡×¨ ×× ×™×™×Ÿ!</div>` : '';

                let nextPrayerBadge = '';
                if (currentFilter === 'minyan' && shul.nextPrayer) {
                    nextPrayerBadge = `
                        <div class="bg-green-50 border-b border-green-100 p-2 text-center">
                            <span class="text-green-800 text-xs font-bold">×”×ª×¤×™×œ×” ×”×‘××”: ${shul.nextPrayer.type} ×‘-${shul.nextPrayer.time}</span>
                        </div>
                    `;
                }

                container.innerHTML += `
                    <div class="card-hover ${alertClass} rounded-2xl shadow-sm border overflow-hidden flex flex-col h-full fade-in-up group relative">
                        ${alertBadge}
                        ${nextPrayerBadge}
                        <div class="p-5 border-b border-slate-100 relative flex-grow transition" onclick="openShulModal('${shul.id}')">
                            <span class="absolute top-4 left-4 bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-full">${shul.nusach || '×ª×¤×™×œ×”'}</span>
                            <h3 class="text-lg font-black text-slate-800 mt-1">
                                ${shul.name}
                                ${shul.nickname ? `<span class="text-base font-medium text-slate-500 mr-1">(${shul.nickname})</span>` : ''}
                            </h3>
                            <p class="text-sm text-slate-400 mb-3"><i class="fas fa-map-marker-alt ml-1"></i>${shul.address || '×˜×™×¨×ª ×”×›×¨××œ'}</p>
                            
                            <div class="grid grid-cols-2 divide-x divide-x-reverse divide-slate-100 bg-slate-50/50 text-xs rounded-lg mt-3">
                                <div class="p-2">
                                    <div class="font-bold text-gray-400 mb-1 border-b border-gray-200 pb-1">×—×•×œ</div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span>×©×—×¨×™×ª:</span> <span class="font-bold">${formatList(shul.shacharit_chol)}</span></div>
                                        <div class="flex justify-between"><span>×× ×—×”:</span> <span class="font-bold">${formatList(shul.mincha_chol)}</span></div>
                                        <div class="flex justify-between"><span>×¢×¨×‘×™×ª:</span> <span class="font-bold">${formatList(shul.arvit_chol)}</span></div>
                                    </div>
                                </div>
                                <div class="p-2 bg-blue-50/30">
                                    <div class="font-bold text-blue-400 mb-1 border-b border-blue-100 pb-1">×©×‘×ª</div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span>×©×—×¨×™×ª:</span> <span class="font-bold">${formatList(shul.shacharit_shabbat)}</span></div>
                                        <div class="flex justify-between"><span>×× ×—×”:</span> <span class="font-bold">${formatList(shul.mincha_shabbat)}</span></div>
                                        <div class="flex justify-between"><span>×¢×¨×‘×™×ª:</span> <span class="font-bold">${formatList(shul.arvit_shabbat)}</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-2 text-center text-blue-500 text-[10px] font-bold opacity-0 group-hover:opacity-100 transition">×œ×—×¥ ×œ×©×™×¢×•×¨×™× ×•×”×•×“×¢×•×ª</div>
                        </div>
                    </div>`;
            });
        }

        async function fetchHebcalData() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const latitude = 32.7599;
            const longitude = 34.9707;
            
            document.getElementById('gregorian-date').innerText = now.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' });

            const shabbatUrl = `https://www.hebcal.com/shabbat?cfg=json&latitude=${latitude}&longitude=${longitude}&M=on&tzid=Asia/Jerusalem`;
            const zmanimUrl = `https://www.hebcal.com/zmanim?cfg=json&latitude=${latitude}&longitude=${longitude}&date=${dateStr}&tzid=Asia/Jerusalem`;
            const converterUrl = `https://www.hebcal.com/converter?cfg=json&gy=${now.getFullYear()}&gm=${now.getMonth()+1}&gd=${now.getDate()}&g2h=1`;

            try {
                const dateRes = await fetch(converterUrl);
                if (dateRes.ok) {
                    const data = await dateRes.json();
                    if(data.hebrew) document.getElementById('hebrew-date').innerText = data.hebrew;
                }
            } catch(e) {}

            try {
                const shabbatRes = await fetch(shabbatUrl);
                if (shabbatRes.ok) {
                    const data = await shabbatRes.json();
                    const parasha = data.items.find(i => i.category === "parashat");
                    if (parasha) document.getElementById('parasha').innerText = parasha.hebrew;
                    
                    const candles = data.items.find(i => i.category === "candles");
                    if (candles) {
                        document.getElementById('shabbat-entry').innerText = getAdjustedTime(candles.date, globalSettings.shabbatEntry || 11);
                        dailyTimes.candles = getAdjustedTime(candles.date, globalSettings.shabbatEntry || 11);
                    }
                    
                    const havdalah = data.items.find(i => i.category === "havdalah");
                    if (havdalah) {
                        document.getElementById('shabbat-exit').innerText = getAdjustedTime(havdalah.date, globalSettings.shabbatExit || 0);
                        dailyTimes.exit = havdalah.date;
                        const shabbatDate = havdalah.date.substring(0, 10);
                        fetchRabenuTam(shabbatDate);
                    }
                }
            } catch(e) {}

            try {
                const zmanimRes = await fetch(zmanimUrl);
                if (zmanimRes.ok) {
                    const data = await zmanimRes.json();
                    const times = data.times;
                    
                    dailyTimes.sunset = times.sunset;
                    dailyTimes.sunrise = getAdjustedTime(times.sunrise, 0);
                    
                    let tzeitDate;
                    if (times.tzeit) {
                        tzeitDate = new Date(times.tzeit);
                    } else {
                        tzeitDate = new Date(times.sunset);
                        tzeitDate.setMinutes(tzeitDate.getMinutes() + 20); 
                    }
                    tzeitDate.setMinutes(tzeitDate.getMinutes() + (globalSettings.tzeit || -8)); 
                    dailyTimes.tzeit = tzeitDate.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', hour12: false});

                    const alot = getAdjustedTime(times.alotHaShachar, globalSettings.alot || 14);
                    const talit = getAdjustedTime(times.misheyakir, globalSettings.talit || -2);
                    const sunrise = getAdjustedTime(times.sunrise, 0);
                    const sunset = getAdjustedTime(times.sunset, 0);

                    const zmanimList = [
                        { label: "×¢×œ×•×ª ×”×©×—×¨", time: alot, icon: "fas fa-cloud-sun" },
                        { label: "×˜×œ×™×ª ×•×ª×¤×™×œ×™×Ÿ", time: talit, icon: "fas fa-praying-hands" },
                        { label: "×”× ×¥ (×–×¨×™×—×”)", time: sunrise, icon: "fas fa-sun" },
                        { label: "×©×§×™×¢×”", time: sunset, icon: "fas fa-sunset" },
                        { label: "×¦××ª ×”×›×•×›×‘×™×", time: dailyTimes.tzeit, icon: "fas fa-star" }
                    ];
                    
                    const zmanimBar = document.getElementById('zmanim-bar');
                    zmanimBar.innerHTML = '';
                    zmanimList.forEach((z, index) => {
                        const isLast = index === zmanimList.length - 1;
                        zmanimBar.innerHTML += `
                            <div class="flex flex-col items-center min-w-[80px] text-center">
                                <span class="text-xs text-blue-200 mb-1">${z.label}</span>
                                <div class="text-lg font-bold text-white flex items-center gap-2">
                                    <i class="${z.icon} text-sm opacity-70"></i> ${z.time}
                                </div>
                            </div>
                            ${!isLast ? '<div class="h-8 w-px bg-blue-600/50"></div>' : ''}
                        `;
                    });
                    
                    renderData();
                }
            } catch(e) {}
        }

        async function fetchRabenuTam(dateStr) {
            const latitude = 32.7599;
            const longitude = 34.9707;
            const url = `https://www.hebcal.com/zmanim?cfg=json&latitude=${latitude}&longitude=${longitude}&date=${dateStr}&tzid=Asia/Jerusalem`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const rt = data.times.tzeit72min;
                if(rt) {
                    document.getElementById('rt-exit').innerText = `×¨"×ª: ${getAdjustedTime(rt, 0)}`;
                }
            } catch(e) {}
        }

        fetchHebcalData();

        // ××™×¨×•×¢×™ ×—×™×¤×•×©
        document.getElementById('manualSearchBtn').addEventListener('click', () => {
            renderData();
        });
        
        document.getElementById('searchShul').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                renderData();
                // ×¡×’×™×¨×ª ××§×œ×“×ª ×‘××•×‘×™×™×œ ×× ×¦×¨×™×š
                document.getElementById('searchShul').blur();
            }
        });

        // ×¢×“×™×™×Ÿ ×©×•××¨×™× ×¢×œ ×—×™×¤×•×© ×—×™ ×›×™ ×–×” × ×¢×™× ×™×•×ª×¨ ×œ××©×ª××©, ××‘×œ ×”×•×¡×¤× ×• ××ª ×”×›×¤×ª×•×¨/×× ×˜×¨ ×œ×’×™×‘×•×™
        document.getElementById('searchShul').addEventListener('input', renderData);

    </script>
</body>
</html>