<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转 住转 专转 专 -  </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.15); }
        .fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .digital-clock { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
        
        /* Minyan Alert Animations */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); border-color: #ef4444; }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); border-color: #ef4444; }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: #ef4444; }
        }
        .minyan-alert { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        
        /* Filter Buttons */
        .filter-btn.active { background-color: #1e3a8a; color: white; border-color: #1e3a8a; }
        .filter-btn { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="text-slate-800 bg-slate-100 flex flex-col min-h-screen">

    <header class="bg-gradient-to-b from-blue-900 to-blue-800 text-white shadow-xl pb-8 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <i class="fas fa-star-of-david absolute top-10 left-10 text-9xl"></i>
            <i class="fas fa-synagogue absolute bottom-10 right-10 text-9xl"></i>
        </div>

        <div class="container mx-auto px-4 py-3 flex justify-between items-center border-b border-blue-700/50 text-sm md:text-base relative z-10">
            <div class="flex items-center gap-2">
                <i class="far fa-calendar-alt text-blue-300"></i>
                <span id="hebrew-date" class="font-bold text-lg text-yellow-300">注 转专...</span>
                <span class="opacity-50 mx-1">|</span>
                <span id="gregorian-date" class="text-blue-200"></span>
            </div>
            <div class="bg-blue-950/80 px-4 py-1 rounded-full border border-blue-600 shadow-lg">
                <span id="parasha" class="font-bold text-orange-300 tracking-wide">注...</span>
            </div>
        </div>

        <div class="container mx-auto px-4 mt-6 relative z-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-8">
                <div class="text-center md:text-right">
                    <h1 class="text-2xl md:text-4xl font-black tracking-tight mb-2 text-white">转 住转 专转 专</h1>
                    <div class="text-5xl md:text-6xl font-black text-blue-100 digital-clock tracking-widest drop-shadow-lg" id="real-time-clock">--:--:--</div>
                </div>

                <div class="flex gap-4">
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-2xl text-center min-w-[130px] shadow-lg">
                        <div class="text-xs text-blue-200 mb-1 font-bold">住转 砖转</div>
                        <div id="shabbat-entry" class="text-3xl font-bold text-white tracking-tight">--:--</div>
                        <div class="mt-1 text-orange-400"><i class="fas fa-candles"></i></div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-2xl text-center min-w-[130px] shadow-lg">
                        <div class="text-xs text-blue-200 mb-1 font-bold">爪转 砖转</div>
                        <div id="shabbat-exit" class="text-3xl font-bold text-white tracking-tight">--:--</div>
                        <div id="rt-exit" class="text-xs text-blue-200 font-bold mt-1 bg-blue-900/50 rounded px-1">专"转: --:--</div>
                        <div class="mt-1 text-purple-300"><i class="fas fa-star"></i></div>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-blue-950/60 rounded-xl p-3 border border-blue-600/50 overflow-x-auto scrollbar-hide shadow-inner">
                <div class="flex justify-between items-center min-w-[600px] gap-6 px-2" id="zmanim-bar">
                    <span class="text-white/50 text-sm animate-pulse">注 转...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow -mt-4 relative z-20">
        <div class="bg-white p-4 rounded-xl shadow-md mb-6 max-w-2xl mx-auto">
            <div class="flex items-center bg-slate-100 p-1 rounded-full mb-4 relative shadow-inner">
                <i class="fas fa-search text-slate-400 mr-4 text-lg"></i>
                <input type="text" id="searchShul" placeholder="驻砖 转 住转, 砖 砖 专,  砖..." class="w-full bg-transparent outline-none font-bold text-lg py-3 pl-20 text-slate-700">
                <button id="manualSearchBtn" class="absolute left-1 top-1 bottom-1 bg-blue-600 text-white px-6 rounded-full font-bold hover:bg-blue-700 transition shadow-md flex items-center gap-2">
                    驻砖 <i class="fas fa-arrow-left text-xs"></i>
                </button>
            </div>
            
            <div class="flex justify-center gap-3">
                <button onclick="setFilter('all')" id="btn-all" class="filter-btn active px-4 py-1 rounded-full font-bold text-sm transition-all shadow-sm"></button>
                <button onclick="setFilter('minyan')" id="btn-minyan" class="filter-btn px-4 py-1 rounded-full font-bold text-sm transition-all shadow-sm flex items-center gap-2"><i class="fas fa-clock"></i>  拽专 憋</button>
            </div>
        </div>

        <div id="prayers-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-20 text-slate-500 bg-white rounded-2xl shadow">
                <i class="fas fa-cloud-download-alt text-4xl mb-4 text-blue-300 animate-bounce"></i>
                <p>转专 转  转...</p>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-slate-200 py-8 mt-auto text-center relative z-20">
        <div class="container mx-auto px-4">
            <p class="text-slate-600 text-sm font-bold tracking-wide">
                &copy; 2026  转 砖专转 注专转   -  转驻 砖注专 转专
            </p>
            <p class="text-slate-400 text-xs mt-2 italic">
                " 注 ' 拽 注 注砖   注"
            </p>
        </div>
    </footer>

    <div id="shulModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-right px-6">
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <p class="text-2xl font-bold text-blue-900" id="modalTitle">砖 转 住转</p>
                    <div class="modal-close cursor-pointer z-50 text-gray-500 hover:text-red-500">
                        <i class="fas fa-times text-2xl"></i>
                    </div>
                </div>

                <div class="mt-4 flex justify-center">
                    <button id="btnMinyanSOS" class="bg-red-100 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white transition rounded-full px-6 py-2 font-bold flex items-center gap-2 text-sm">
                        <i class="fas fa-bell"></i> 住专  ! 抓  
                    </button>
                </div>

                <div id="modalBody" class="mt-4 space-y-4">
                    </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end">
                    <a id="modalNavBtn" href="#" target="_blank" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2">
                        <i class="fas fa-location-arrow"></i>  拽
                    </a>
                </div>
            </div>
        </div>
    </div>

    <a href="admin.html" class="fixed bottom-6 left-6 bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl hover:bg-slate-700 transition z-50 flex items-center gap-3 font-bold border border-slate-600 opacity-90 hover:opacity-100">
        <i class="fas fa-user-cog text-xl"></i>
        <span> </span>
    </a>

    <a href="https://kosher-e90e3.web.app/" target="_blank" class="fixed bottom-6 right-6 bg-red-600 text-white px-5 py-3 rounded-full shadow-2xl hover:bg-red-700 transition z-50 flex items-center gap-3 font-bold border border-red-500 opacity-90 hover:opacity-100">
        <i class="fab fa-youtube text-xl"></i>
        <span> 砖专</span>
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArvTHLvtHZwguLn0OpPMMJdqDKS7OnDOg",
            authDomain: "tirat-carmel-shul.firebaseapp.com",
            databaseURL: "https://tirat-carmel-shul-default-rtdb.firebaseio.com",
            projectId: "tirat-carmel-shul",
            storageBucket: "tirat-carmel-shul.firebasestorage.app",
            messagingSenderId: "645574971282",
            appId: "1:645574971282:web:9fb6720ea7c960ca37fb4b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let liveShuls = [];
        let liveLessons = [];
        let globalSettings = {};
        let minyanAlerts = {};
        let dailyTimes = {}; 
        let currentFilter = 'all';

        function updateClock() {
            const now = new Date();
            document.getElementById('real-time-clock').innerText = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }
        setInterval(updateClock, 1000);
        updateClock();

        onValue(ref(db, 'settings'), (snapshot) => {
            globalSettings = snapshot.val() || { shabbatEntry: 11, shabbatExit: 0, alot: 14, talit: -2, tzeit: -8 };
            fetchHebcalData();
        });

        onValue(ref(db, 'prayers'), (snapshot) => {
            const data = snapshot.val();
            liveShuls = data ? Object.entries(data).map(([k, v]) => ({ id: k, ...v })) : [];
            renderData();
        });

        onValue(ref(db, 'lessons'), (snapshot) => {
            const data = snapshot.val();
            liveLessons = data ? Object.values(data) : [];
            renderData();
        });

        onValue(ref(db, 'minyanAlerts'), (snapshot) => {
            minyanAlerts = snapshot.val() || {};
            renderData();
        });

        window.setFilter = (type) => {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(type === 'all' ? 'btn-all' : 'btn-minyan').classList.add('active');
            renderData();
        }

        function getAdjustedTime(isoDateString, minutesToAdd) {
            if (!isoDateString) return "--:--";
            const date = new Date(isoDateString);
            date.setMinutes(date.getMinutes() + minutesToAdd);
            return date.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', hour12: false});
        }

        function parseDynamicTime(rawText) {
            if (!rawText || !dailyTimes.sunset) return rawText;
            let timeStr = rawText;

            if (rawText.includes("驻 砖拽注")) {
                const mins = parseInt(rawText.match(/(\d+)\s*拽/)?.[1] || 0);
                timeStr = timeStr.replace(/\d+\s*拽'\s*驻\s*砖拽注/, getAdjustedTime(dailyTimes.sunset, -mins));
            } else if (rawText.includes("驻 爪转 砖转")) {
                const mins = parseInt(rawText.match(/(\d+)\s*拽/)?.[1] || 0);
                timeStr = timeStr.replace(/\d+\s*拽'\s*驻\s*爪转\s*砖转/, getAdjustedTime(dailyTimes.exit, -mins));
            } else if (rawText.includes("爪转 ")) {
                timeStr = timeStr.replace("爪转 ", dailyTimes.tzeit);
            } else if (rawText.includes("砖拽注")) {
                timeStr = timeStr.replace("砖拽注", getAdjustedTime(dailyTimes.sunset, 0));
            } else if (rawText.includes("住转 砖转")) {
                timeStr = timeStr.replace("住转 砖转", dailyTimes.candles);
            } else if (rawText.includes("抓")) {
                timeStr = timeStr.replace("抓", dailyTimes.sunrise);
            }
            return timeStr;
        }

        function timeToMinutes(timeStr) {
            if(!timeStr || !timeStr.includes(':')) return -1;
            const match = timeStr.match(/\d{2}:\d{2}/);
            if(!match) return -1;
            const [h, m] = match[0].split(':').map(Number);
            return h * 60 + m;
        }

        const formatList = (str) => {
            if (!str) return '-';
            return str.split(', ').map(timeStr => parseDynamicTime(timeStr)).join('<br>');
        };

        const modal = document.getElementById('shulModal');
        const closeModal = document.querySelectorAll('.modal-close, .modal-overlay');

        function toggleModal() {
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }

        closeModal.forEach(el => el.addEventListener('click', toggleModal));

        window.triggerMinyanAlert = (shulId) => {
            if (confirm(" 驻注 转专转 住专  -10 拽转?")) {
                const alertRef = ref(db, `minyanAlerts/${shulId}`);
                set(alertRef, Date.now());
                alert("转专 驻注 转驻注 祝 专砖.");
                toggleModal();
            }
        };

        window.openShulModal = (shulId) => {
            const shul = liveShuls.find(s => s.id === shulId);
            if (!shul) return;

            document.getElementById('modalTitle').innerText = shul.name;
            if(shul.nickname) document.getElementById('modalTitle').innerText += ` (${shul.nickname})`;
            
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(shul.address || shul.name + " 专转 专")}`;
            document.getElementById('modalNavBtn').href = mapUrl;

            const sosBtn = document.getElementById('btnMinyanSOS');
            sosBtn.onclick = () => triggerMinyanAlert(shul.id);

            const shulLessons = liveLessons.filter(l => l.location === shul.name);
            let lessonsHtml = '';
            if (shulLessons.length > 0) {
                lessonsHtml = `<div class="bg-orange-50 p-4 rounded-lg mt-4 border border-orange-100"><h4 class="font-bold text-orange-800 mb-2">砖注专 转专</h4>`;
                shulLessons.forEach(l => {
                    let rabbiName = l.rabbi.trim();
                    if (!rabbiName.startsWith('专')) rabbiName = '专 ' + rabbiName;
                    lessonsHtml += `
                        <div class="flex justify-between items-start text-sm bg-white p-2 mb-2 rounded border border-orange-200">
                            <div><span class="font-bold">${rabbiName}</span> - ${l.title}</div>
                            <div class="text-left"><span class="bg-orange-100 px-1 rounded">${l.day}</span> ${l.time}</div>
                        </div>`;
                });
                lessonsHtml += `</div>`;
            }

            let messagesHtml = '';
            if (shul.message || shul.refuahNames || shul.iluiNishmatNames) {
                messagesHtml = `<div class="mt-6 space-y-3">`;
                if (shul.message) messagesHtml += `<div class="bg-blue-100 p-3 rounded-lg border border-blue-200"><h5 class="font-bold text-blue-900 mb-1 text-sm"><i class="fas fa-bullhorn ml-1"></i> 注 砖:</h5><p class="text-sm whitespace-pre-wrap">${shul.message}</p></div>`;
                if (shul.refuahNames) messagesHtml += `<div class="bg-green-50 p-3 rounded-lg border border-green-200"><h5 class="font-bold text-green-900 mb-1 text-sm"><i class="fas fa-heartbeat ml-1"></i> 专驻 砖:</h5><p class="text-sm whitespace-pre-wrap">${shul.refuahNames}</p></div>`;
                if (shul.iluiNishmatNames) messagesHtml += `<div class="bg-gray-100 p-3 rounded-lg border border-gray-300"><h5 class="font-bold text-gray-800 mb-1 text-sm"><i class="fas fa-candle-holder ml-1"></i> 注 砖转:</h5><p class="text-sm whitespace-pre-wrap">${shul.iluiNishmatNames}</p></div>`;
                messagesHtml += `</div>`;
            }

            const detailsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="text-sm text-gray-500 mb-1"><i class="fas fa-map-marker-alt ml-2"></i>转转</div>
                        <div class="font-bold text-lg mb-3">${shul.address || ' 爪'}</div>
                        <div class="text-sm text-gray-500 mb-1"><i class="fas fa-book ml-2"></i>住</div>
                        <div class="font-bold text-lg mb-3">${shul.nusach || ' 爪'}</div>
                        ${shul.rabbi ? `<div class="text-sm text-gray-500 mb-1">专</div><div class="font-bold text-lg mb-3">${shul.rabbi}</div>` : ''}
                        ${shul.gabbai ? `<div class="text-sm text-gray-500 mb-1"></div><div class="font-bold text-lg mb-3">${shul.gabbai}</div>` : ''}
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-bold text-blue-900 border-b border-gray-200 pb-2 mb-2"> 转驻 (砖 )</h4>
                        <div class="space-y-3 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="block font-bold text-gray-500"> - 砖专转</span><span>${formatList(shul.shacharit_chol)}</span></div>
                                <div><span class="block font-bold text-blue-500">砖转 - 砖专转</span><span>${formatList(shul.shacharit_shabbat)}</span></div>
                                <div><span class="block font-bold text-gray-500"> - </span><span>${formatList(shul.mincha_chol)}</span></div>
                                <div><span class="block font-bold text-blue-500">砖转 - </span><span>${formatList(shul.mincha_shabbat)}</span></div>
                                <div><span class="block font-bold text-gray-500"> - 注专转</span><span>${formatList(shul.arvit_chol)}</span></div>
                                <div><span class="block font-bold text-blue-500">砖转 - 注专转</span><span>${formatList(shul.arvit_shabbat)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                ${lessonsHtml}
                ${messagesHtml}
            `;

            document.getElementById('modalBody').innerHTML = detailsHtml;
            toggleModal();
        };

        function renderData() {
            const container = document.getElementById('prayers-grid');
            const search = document.getElementById('searchShul').value.toLowerCase();
            
            let filteredShuls = liveShuls.filter(s => {
                const inName = s.name.toLowerCase().includes(search);
                const inAddress = (s.address || "").toLowerCase().includes(search);
                const inNusach = (s.nusach || "").toLowerCase().includes(search);
                
                let inLessons = false;
                if (liveLessons) {
                    const shulLessons = liveLessons.filter(l => l.location === s.name);
                    inLessons = shulLessons.some(l => 
                        (l.rabbi && l.rabbi.toLowerCase().includes(search)) || 
                        (l.topic && l.topic.toLowerCase().includes(search))
                    );
                }
                
                return inName || inAddress || inNusach || inLessons;
            });

            if (currentFilter === 'minyan') {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                
                filteredShuls = filteredShuls.map(s => {
                    let nextPrayer = null;
                    let minDiff = Infinity;
                    
                    const timesToCheck = [
                        { type: '砖专转', val: s.shacharit_chol },
                        { type: '', val: s.mincha_chol },
                        { type: '注专转', val: s.arvit_chol }
                    ];

                    timesToCheck.forEach(t => {
                        if(!t.val) return;
                        const times = t.val.split(', ');
                        times.forEach(rawTime => {
                            const parsed = parseDynamicTime(rawTime);
                            const tMins = timeToMinutes(parsed);
                            
                            if (tMins > currentMinutes) {
                                const diff = tMins - currentMinutes;
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    nextPrayer = { type: t.type, time: parsed, rawDiff: diff };
                                }
                            }
                        });
                    });

                    return { ...s, nextPrayer };
                })
                .filter(s => s.nextPrayer) 
                .sort((a, b) => a.nextPrayer.rawDiff - b.nextPrayer.rawDiff);
            } else {
                filteredShuls.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            }

            if (filteredShuls.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-slate-500 bg-white rounded-2xl shadow"><p> 爪 转爪转.</p></div>`;
                return;
            }

            container.innerHTML = '';
            const now = Date.now();
            
            filteredShuls.forEach(shul => {
                let isAlertActive = false;
                if (minyanAlerts[shul.id]) {
                    const diff = now - minyanAlerts[shul.id];
                    if (diff < 10 * 60 * 1000) isAlertActive = true;
                }

                const alertClass = isAlertActive ? 'minyan-alert bg-red-50' : 'bg-white border-slate-100';
                const alertBadge = isAlertActive ? `<div class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg animate-pulse z-20">住专 !</div>` : '';

                let nextPrayerBadge = '';
                if (currentFilter === 'minyan' && shul.nextPrayer) {
                    nextPrayerBadge = `
                        <div class="bg-green-50 border-b border-green-100 p-2 text-center">
                            <span class="text-green-800 text-xs font-bold">转驻 : ${shul.nextPrayer.type} -${shul.nextPrayer.time}</span>
                        </div>
                    `;
                }

                container.innerHTML += `
                    <div class="card-hover ${alertClass} rounded-2xl shadow-sm border overflow-hidden flex flex-col h-full fade-in-up group relative">
                        ${alertBadge}
                        ${nextPrayerBadge}
                        <div class="p-5 border-b border-slate-100 relative flex-grow transition" onclick="openShulModal('${shul.id}')">
                            <span class="absolute top-4 left-4 bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-full">${shul.nusach || '转驻'}</span>
                            <h3 class="text-lg font-black text-slate-800 mt-1">
                                ${shul.name}
                                ${shul.nickname ? `<span class="text-base font-medium text-slate-500 mr-1">(${shul.nickname})</span>` : ''}
                            </h3>
                            <p class="text-sm text-slate-400 mb-3"><i class="fas fa-map-marker-alt ml-1"></i>${shul.address || '专转 专'}</p>
                            
                            <div class="grid grid-cols-2 divide-x divide-x-reverse divide-slate-100 bg-slate-50/50 text-xs rounded-lg mt-3">
                                <div class="p-2">
                                    <div class="font-bold text-gray-400 mb-1 border-b border-gray-200 pb-1"></div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span>砖专转:</span> <span class="font-bold">${formatList(shul.shacharit_chol)}</span></div>
                                        <div class="flex justify-between"><span>:</span> <span class="font-bold">${formatList(shul.mincha_chol)}</span></div>
                                        <div class="flex justify-between"><span>注专转:</span> <span class="font-bold">${formatList(shul.arvit_chol)}</span></div>
                                    </div>
                                </div>
                                <div class="p-2 bg-blue-50/30">
                                    <div class="font-bold text-blue-400 mb-1 border-b border-blue-100 pb-1">砖转</div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span>砖专转:</span> <span class="font-bold">${formatList(shul.shacharit_shabbat)}</span></div>
                                        <div class="flex justify-between"><span>:</span> <span class="font-bold">${formatList(shul.mincha_shabbat)}</span></div>
                                        <div class="flex justify-between"><span>注专转:</span> <span class="font-bold">${formatList(shul.arvit_shabbat)}</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-2 text-center text-blue-500 text-[10px] font-bold opacity-0 group-hover:opacity-100 transition">抓 砖注专 注转</div>
                        </div>
                    </div>`;
            });
        }

        async function fetchHebcalData() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const latitude = 32.7599;
            const longitude = 34.9707;
            
            document.getElementById('gregorian-date').innerText = now.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' });

            const shabbatUrl = `https://www.hebcal.com/shabbat?cfg=json&latitude=${latitude}&longitude=${longitude}&M=on&tzid=Asia/Jerusalem`;
            const zmanimUrl = `https://www.hebcal.com/zmanim?cfg=json&latitude=${latitude}&longitude=${longitude}&date=${dateStr}&tzid=Asia/Jerusalem`;
            const converterUrl = `https://www.hebcal.com/converter?cfg=json&gy=${now.getFullYear()}&gm=${now.getMonth()+1}&gd=${now.getDate()}&g2h=1`;

            try {
                const dateRes = await fetch(converterUrl);
                if (dateRes.ok) {
                    const data = await dateRes.json();
                    if(data.hebrew) document.getElementById('hebrew-date').innerText = data.hebrew;
                }
            } catch(e) {}

            try {
                const shabbatRes = await fetch(shabbatUrl);
                if (shabbatRes.ok) {
                    const data = await shabbatRes.json();
                    const parasha = data.items.find(i => i.category === "parashat");
                    if (parasha) document.getElementById('parasha').innerText = parasha.hebrew;
                    
                    const candles = data.items.find(i => i.category === "candles");
                    if (candles) {
                        document.getElementById('shabbat-entry').innerText = getAdjustedTime(candles.date, globalSettings.shabbatEntry || 11);
                        dailyTimes.candles = getAdjustedTime(candles.date, globalSettings.shabbatEntry || 11);
                    }
                    
                    const havdalah = data.items.find(i => i.category === "havdalah");
                    if (havdalah) {
                        document.getElementById('shabbat-exit').innerText = getAdjustedTime(havdalah.date, globalSettings.shabbatExit || 0);
                        dailyTimes.exit = havdalah.date;
                        const shabbatDate = havdalah.date.substring(0, 10);
                        fetchRabenuTam(shabbatDate);
                    }
                }
            } catch(e) {}

            try {
                const zmanimRes = await fetch(zmanimUrl);
                if (zmanimRes.ok) {
                    const data = await zmanimRes.json();
                    const times = data.times;
                    
                    dailyTimes.sunset = times.sunset;
                    dailyTimes.sunrise = getAdjustedTime(times.sunrise, 0);
                    
                    let tzeitDate;
                    if (times.tzeit) {
                        tzeitDate = new Date(times.tzeit);
                    } else {
                        tzeitDate = new Date(times.sunset);
                        tzeitDate.setMinutes(tzeitDate.getMinutes() + 20); 
                    }
                    tzeitDate.setMinutes(tzeitDate.getMinutes() + (globalSettings.tzeit || -8)); 
                    dailyTimes.tzeit = tzeitDate.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', hour12: false});

                    const alot = getAdjustedTime(times.alotHaShachar, globalSettings.alot || 14);
                    const talit = getAdjustedTime(times.misheyakir, globalSettings.talit || -2);
                    const sunrise = getAdjustedTime(times.sunrise, 0);
                    const sunset = getAdjustedTime(times.sunset, 0);

                    const zmanimList = [
                        { label: "注转 砖专", time: alot, icon: "fas fa-cloud-sun" },
                        { label: "转 转驻", time: talit, icon: "fas fa-praying-hands" },
                        { label: "抓 (专)", time: sunrise, icon: "fas fa-sun" },
                        { label: "砖拽注", time: sunset, icon: "fas fa-sunset" },
                        { label: "爪转 ", time: dailyTimes.tzeit, icon: "fas fa-star" }
                    ];
                    
                    const zmanimBar = document.getElementById('zmanim-bar');
                    zmanimBar.innerHTML = '';
                    zmanimList.forEach((z, index) => {
                        const isLast = index === zmanimList.length - 1;
                        zmanimBar.innerHTML += `
                            <div class="flex flex-col items-center min-w-[80px] text-center">
                                <span class="text-xs text-blue-200 mb-1">${z.label}</span>
                                <div class="text-lg font-bold text-white flex items-center gap-2">
                                    <i class="${z.icon} text-sm opacity-70"></i> ${z.time}
                                </div>
                            </div>
                            ${!isLast ? '<div class="h-8 w-px bg-blue-600/50"></div>' : ''}
                        `;
                    });
                    
                    renderData();
                }
            } catch(e) {}
        }

        async function fetchRabenuTam(dateStr) {
            const latitude = 32.7599;
            const longitude = 34.9707;
            const url = `https://www.hebcal.com/zmanim?cfg=json&latitude=${latitude}&longitude=${longitude}&date=${dateStr}&tzid=Asia/Jerusalem`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const rt = data.times.tzeit72min;
                if(rt) {
                    document.getElementById('rt-exit').innerText = `专"转: ${getAdjustedTime(rt, 0)}`;
                }
            } catch(e) {}
        }

        fetchHebcalData();

        // 专注 驻砖
        document.getElementById('manualSearchBtn').addEventListener('click', () => {
            renderData();
        });
        
        document.getElementById('searchShul').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                renderData();
                // 住专转 拽转   爪专
                document.getElementById('searchShul').blur();
            }
        });

        // 注 砖专 注 驻砖    注 转专 砖转砖,  住驻 转 驻转专/专 
        document.getElementById('searchShul').addEventListener('input', renderData);

    </script>
</body>
</html>